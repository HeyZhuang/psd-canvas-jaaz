# Jaaz 服務端口配置說明

## 📋 正確的端口配置

### 前端服務
- **端口**: `3100`
- **配置文件**: `react/vite.config.ts`
- **配置項**: `server.port = 3100`
- **訪問地址**: http://localhost:3100
- **主要頁面**: http://localhost:3100/canvas/default

### 後端服務  
- **端口**: `58000`
- **配置文件**: `server/main.py`
- **配置項**: `--port 58000` (默認值)
- **訪問地址**: http://localhost:58000
- **API文檔**: http://localhost:58000/docs

### API代理配置
- **配置文件**: `react/vite.config.ts`
- **代理規則**: `/api` → `http://127.0.0.1:58000`
- **WebSocket**: `/ws` → `ws://127.0.0.1:58000`

## 🔍 如何檢查當前配置

### 方法 1：使用診斷腳本（推薦）
```bash
cd /home/ubuntu/jaaz
./test_智能縮放連接.sh
```

### 方法 2：手動檢查
```bash
# 檢查前端端口
lsof -i :3100 | grep LISTEN

# 檢查後端端口  
lsof -i :58000 | grep LISTEN

# 檢查進程詳情
ps aux | grep "vite"
ps aux | grep "python.*main.py"
```

### 方法 3：測試連接
```bash
# 測試前端
curl http://localhost:3100/

# 測試後端
curl http://localhost:58000/api/config

# 測試前端API代理
curl http://localhost:3100/api/config
```

## ⚙️ 配置文件詳情

### react/vite.config.ts
```typescript
const PORT = 58000  // 後端端口

export default defineConfig(({ mode }) => {
  const config: UserConfig = {
    server: {
      port: 3100,  // 前端端口
      proxy: {},
    },
  }

  if (mode === 'development') {
    config.server.proxy = {
      '/api': {
        target: `http://127.0.0.1:${PORT}`,  // 代理到後端
        changeOrigin: true,
      },
      '/ws': {
        target: `ws://127.0.0.1:${PORT}`,
        ws: true,
      },
    }
  }

  return config
})
```

### server/main.py
```python
if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--port', type=int, default=58000,
                        help='Port to run the server on')
    args = parser.parse_args()

    import uvicorn
    uvicorn.run(
        app,
        host='127.0.0.1',
        port=args.port,  # 默認 58000
    )
```

### server/common.py
```python
DEFAULT_PORT = int(os.environ.get('DEFAULT_PORT', 58000))
```

## 🚀 啟動服務

### 前端啟動
```bash
cd /home/ubuntu/jaaz/react
npm run dev
# 或使用腳本
cd /home/ubuntu/jaaz
./restart_frontend.sh
```

### 後端啟動
```bash
cd /home/ubuntu/jaaz/server
python main.py
# 或使用腳本  
cd /home/ubuntu/jaaz
./restart_backend.sh

# 或指定端口
cd /home/ubuntu/jaaz/server
python main.py --port 58000
```

## 🔧 修改端口（如果需要）

### 修改前端端口
編輯 `react/vite.config.ts`:
```typescript
server: {
  port: 您的新端口,  // 例如：3000
  proxy: {},
}
```

### 修改後端端口
方法1 - 環境變量:
```bash
export DEFAULT_PORT=您的新端口
python main.py
```

方法2 - 命令行參數:
```bash
python main.py --port 您的新端口
```

方法3 - 修改代碼:
編輯 `server/main.py`:
```python
parser.add_argument('--port', type=int, default=您的新端口)
```

### ⚠️ 重要提醒
如果修改了後端端口，必須同步修改前端代理配置：

編輯 `react/vite.config.ts`:
```typescript
const PORT = 您的新後端端口  // 修改這裡
```

## 🐛 常見問題

### Q: 為什麼 check_services.sh 顯示錯誤的端口？
A: 該腳本可能已過時。請使用 `test_智能縮放連接.sh` 進行診斷。

### Q: 如何確認代理是否工作？
A: 運行以下命令：
```bash
curl http://localhost:3100/api/config
```
如果返回 JSON 數據（而不是 404），代理就是工作的。

### Q: 前端無法連接到後端怎麼辦？
A: 按順序檢查：
1. 後端是否運行：`lsof -i :58000`
2. 前端是否運行：`lsof -i :3100`
3. 代理配置是否正確：查看 `react/vite.config.ts`
4. 重啟兩個服務

### Q: API請求返回 502/503 錯誤？
A: 這表示後端未運行或無法訪問。請：
1. 檢查後端進程：`ps aux | grep "python.*main.py"`
2. 重啟後端：`./restart_backend.sh`
3. 查看後端日誌：`tail -50 /home/ubuntu/jaaz/server/backend.log`

## 📊 端口使用總覽

| 服務 | 端口 | 協議 | 用途 |
|------|------|------|------|
| 前端 Vite | 3100 | HTTP | Web界面服務 |
| 後端 FastAPI | 58000 | HTTP/WS | API服務和WebSocket |
| 前端代理 | 3100 → 58000 | HTTP | API請求轉發 |

## ✅ 驗證清單

配置正確時，應該能看到：

- [ ] `lsof -i :3100` 顯示 node 進程
- [ ] `lsof -i :58000` 顯示 python 進程  
- [ ] `curl http://localhost:3100/` 返回 HTML
- [ ] `curl http://localhost:58000/api/config` 返回 JSON
- [ ] `curl http://localhost:3100/api/config` 返回相同的 JSON
- [ ] 瀏覽器訪問 http://localhost:3100 能看到界面

---

**最後更新**: 2025-10-29
**診斷工具**: test_智能縮放連接.sh




