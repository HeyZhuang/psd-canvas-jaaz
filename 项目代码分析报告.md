# Jaaz 项目代码全面分析报告

## 📋 项目概述

**项目名称**: Jaaz  
**版本**: 1.0.30  
**定位**: 开源的 Canva AI 替代品  
**描述**: 世界首个开源多模态创意助手，优先保护隐私的本地设计工具  
**技术栈**: Electron + React + FastAPI + Python  

---

## 🏗️ 项目架构

### 整体架构
```
Jaaz/
├── electron/          # Electron 主进程代码
├── react/             # React 前端应用
│   └── src/
│       ├── components/  # UI组件
│       ├── api/         # API调用
│       ├── contexts/    # React上下文
│       ├── hooks/       # 自定义钩子
│       ├── stores/      # 状态管理
│       └── utils/       # 工具函数
├── server/            # FastAPI 后端服务
│   ├── routers/       # API路由
│   ├── services/      # 业务服务
│   ├── utils/         # 工具函数
│   ├── models/        # 数据模型
│   └── tools/         # 工具集
├── resize/            # PSD缩放独立模块
├── scripts/           # 构建脚本
└── assets/            # 静态资源
```

---

## 🎯 核心功能模块

### 1. **Magic Canvas（魔法画布）** ⭐
**位置**: `react/src/components/canvas/`

**核心组件**:
- `CanvasExcali.tsx` - 基于 Excalidraw 的画布实现
- `CanvasHeader.tsx` - 画布顶部工具栏
- `CanvasToolMenu.tsx` - 画布工具菜单
- `LayerToolbar.tsx` - 图层工具栏

**功能特性**:
- ✅ 无限画布
- ✅ 自由绘制和组合
- ✅ 实时协作支持
- ✅ AI 即时理解和生成
- ✅ 无需提示词创作

**技术实现**:
```typescript
// 使用 @excalidraw/excalidraw 库
import { Excalidraw } from '@excalidraw/excalidraw';

// 核心 API
const excalidrawAPI = useRef<ExcalidrawImperativeAPI>(null);
```

---

### 2. **PSD 智能处理系统** 🎨
**位置**: `server/routers/psd_*.py` + `react/src/components/canvas/PSD*.tsx`

#### 2.1 PSD 上传和解析
**后端**: `server/routers/psd_router.py`
- PSD 文件上传
- 图层信息提取
- 预览图生成
- 元数据管理

**前端**: `react/src/components/canvas/PSDCanvasUploader.tsx`
- 拖拽上传
- 进度显示
- 图层预览

#### 2.2 PSD 图层编辑器
**组件**: `PSDLayerEditor.tsx` / `PSDLayerEditorOptimized.tsx`

**功能**:
- ✅ 图层可见性切换
- ✅ 图层重命名
- ✅ 图层删除
- ✅ 透明度调整
- ✅ 混合模式
- ✅ 拖拽排序

**技术**:
```typescript
// 图层数据结构
interface PSDLayer {
  id: number;
  name: string;
  type: 'pixel' | 'group';
  visible: boolean;
  opacity: number;
  left: number;
  top: number;
  width: number;
  height: number;
}
```

#### 2.3 PSD 智能缩放 ⚡
**后端**: 
- `server/routers/psd_resize_router.py` - PSD文件缩放
- `server/routers/canvas_resize_router.py` - 画布缩放（新）

**前端**: `react/src/components/canvas/PSDResizeDialog.tsx`

**核心功能**:
1. **单个PSD缩放**
   - 上传PSD文件
   - 设置目标尺寸
   - Gemini AI 智能分析
   - 保持图层结构

2. **画布整体缩放** ✨（新功能）
   - 收集画布所有图片
   - 创建临时PSD
   - 智能缩放
   - 支持PNG/PSD输出

**AI集成**:
```python
# 使用 Gemini 2.5 Pro 分析图层
from services.gemini_psd_resize_service import GeminiPSDResizeService

service = GeminiPSDResizeService(api_key=api_key)
new_positions = await service.resize_psd_layers(
    layers_info=layers_info,
    detection_image_path=detection_image_path,
    target_width=target_width,
    target_height=target_height
)
```

**工作流程**:
```
1. 上传PSD或收集画布数据
   ↓
2. 提取图层信息
   ↓
3. 生成检测框图像
   ↓
4. Gemini AI 分析并生成新位置
   ↓
5. 重建图层
   ↓
6. 输出PNG或PSD
   ↓
7. 自动展示到画布
```

---

### 3. **AI 聊天代理系统** 🤖
**位置**: `server/routers/chat_router.py` + `react/src/components/chat/`

**功能**:
- ✅ 多轮对话
- ✅ 插入对象
- ✅ 风格转换
- ✅ 逻辑控制
- ✅ 本地模型（ComfyUI）
- ✅ 云端模型集成

**支持的AI模型**:
- GPT-4o
- Midjourney
- VEO3
- Kling
- Seedance
- Ollama (本地)

---

### 4. **模板管理系统** 📄
**位置**: `server/routers/template_router.py`

**功能**:
- 模板保存
- 模板加载
- 模板预览
- 模板分类
- 自动保存

---

### 5. **字体管理** 🔤
**位置**: `server/routers/font_router.py` + `react/src/components/canvas/FontEditor.tsx`

**功能**:
- 字体上传
- 字体解析
- 字体预览
- 字体选择器

---

### 6. **图片生成和处理** 🖼️
**位置**: `server/routers/image_router.py`

**功能**:
- 图片上传
- 图片生成
- 图片编辑
- 图片导出

---

## 🔌 API 端点总览

### 核心 API

#### PSD 相关
```
POST   /api/psd/upload              # 上传PSD文件
GET    /api/psd/layers/{file_id}    # 获取图层信息
POST   /api/psd/resize              # PSD智能缩放
GET    /api/psd/resize/output/{id}  # 获取缩放结果
POST   /api/psd/export              # 导出PSD
```

#### 画布相关
```
POST   /api/canvas/resize           # 画布智能缩放 ✨
GET    /api/canvas/health           # 健康检查
POST   /api/canvas/save             # 保存画布
GET    /api/canvas/load/{id}        # 加载画布
```

#### 聊天相关
```
POST   /api/chat/message            # 发送消息
GET    /api/chat/history            # 获取历史
WS     /socket.io                   # WebSocket连接
```

#### 配置相关
```
GET    /api/config                  # 获取配置
POST   /api/config                  # 更新配置
GET    /api/settings                # 获取设置
```

---

## 🛠️ 技术栈详解

### 前端技术栈

#### 核心框架
```json
{
  "react": "^19.1.0",
  "typescript": "~5.7.2",
  "vite": "^6.2.0"
}
```

#### UI库和组件
```json
{
  "@excalidraw/excalidraw": "^0.18.0",      // 画布引擎
  "@radix-ui/*": "latest",                   // UI组件库
  "tailwindcss": "^4.0.17",                  // CSS框架
  "lucide-react": "^0.484.0",                // 图标库
  "sonner": "^2.0.3"                         // 通知组件
}
```

#### 状态管理
```json
{
  "zustand": "^5.0.5",                       // 轻量状态管理
  "@tanstack/react-query": "^5.80.3"        // 数据获取
}
```

#### 路由
```json
{
  "@tanstack/react-router": "^1.120.15"     // 类型安全路由
}
```

#### 其他重要库
```json
{
  "socket.io-client": "^4.8.1",              // WebSocket
  "jszip": "^3.10.1",                        // ZIP处理
  "openai": "^4.98.0",                       // OpenAI集成
  "i18next": "^25.2.1"                       // 国际化
}
```

### 后端技术栈

#### 核心框架
```python
fastapi                # Web框架
uvicorn[standard]      # ASGI服务器
python-socketio==5.13.0  # WebSocket
```

#### AI和ML
```python
anthropic              # Claude API
openai                 # GPT API
ollama                 # 本地模型
google-genai           # Gemini API
langgraph==0.4.8       # AI工作流
langchain-core         # AI链
```

#### 图像处理
```python
Pillow                 # 图像处理
psd-tools              # PSD解析
piexif                 # EXIF元数据
numpy                  # 数值计算
```

#### 数据库和存储
```python
sqlalchemy             # ORM
aiosqlite              # 异步SQLite
```

#### 其他工具
```python
aiohttp                # 异步HTTP
aiofiles               # 异步文件I/O
python-multipart       # 文件上传
fonttools              # 字体处理
```

---

## 📂 关键文件解析

### 1. 前端入口
**文件**: `react/src/main.tsx`
```typescript
// 应用入口
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
```

### 2. 后端入口
**文件**: `server/main.py`
```python
# FastAPI应用
app = FastAPI(lifespan=lifespan)

# CORS中间件
app.add_middleware(CORSMiddleware, ...)

# 路由注册
app.include_router(psd_router.router)
app.include_router(canvas_resize_router.router)

# Socket.IO集成
socket_app = socketio.ASGIApp(sio, other_asgi_app=app)

# 启动服务器
uvicorn.run(socket_app, host="127.0.0.1", port=58000)
```

### 3. 画布工具集合
**文件**: `react/src/utils/canvasToPSD.ts`
```typescript
// 画布数据收集
export function collectCanvasImageData(
  excalidrawAPI: ExcalidrawImperativeAPI
): CanvasData | null

// 数据验证
export function validateCanvasData(
  canvasData: CanvasData | null
): boolean
```

### 4. PSD处理工具
**文件**: `server/utils/canvas_to_psd.py`
```python
# Base64图片解码
def decode_base64_image(data_url: str) -> Image.Image

# 保存独立图层
def save_canvas_layers_separate(
    canvas_data: Dict[str, Any],
    output_dir: str
) -> Dict[str, Any]

# 创建多层PSD
def create_layered_psd_from_resized(
    layer_files: List[Dict[str, Any]],
    new_positions: List[Dict[str, Any]],
    target_width: int,
    target_height: int,
    output_path: str
) -> str
```

### 5. Gemini AI服务
**文件**: `server/services/gemini_psd_resize_service.py`
```python
class GeminiPSDResizeService:
    async def resize_psd_layers(
        self,
        layers_info: List[Dict],
        detection_image_path: str,
        original_width: int,
        original_height: int,
        target_width: int,
        target_height: int
    ) -> List[Dict]:
        # 使用Gemini 2.5 Pro分析图层
        # 返回智能缩放方案
```

---

## 🔐 配置和环境

### 环境变量
**文件**: `config.env`
```bash
# Gemini API密钥
GEMINI_API_KEY=your_api_key_here

# 后端端口
DEFAULT_PORT=58000

# UI构建目录
UI_DIST_DIR=/path/to/react/dist
```

### 端口配置
- **前端开发**: 3100
- **后端服务**: 58000
- **Electron**: 动态端口

### API密钥管理
**工具**: `setup_api_key.py`
```python
# 交互式API密钥设置
# 支持Gemini、OpenAI等多个服务
```

---

## 🚀 部署和构建

### 开发环境启动
```bash
# 前端
cd react
npm install --force
npm run dev  # http://localhost:3100

# 后端
cd server
pip install -r requirements.txt
python main.py  # http://127.0.0.1:58000
```

### Electron桌面应用
```bash
# 开发模式
npm run dev

# 构建
npm run build:mac    # macOS
npm run build:win    # Windows
npm run build:linux  # Linux
```

### 生产环境
```bash
# 完整构建
npm start

# 或
cd react && npx vite build
cd ../server && python main.py
```

---

## 📊 数据流分析

### PSD智能缩放数据流

```
用户上传PSD或选择画布
        ↓
前端：collectCanvasImageData()
        ↓
POST /api/canvas/resize
        ↓
后端：解析数据
        ↓
后端：保存图层（PNG/PSD模式）
        ↓
后端：构造图层信息
        ↓
后端：生成检测框图像
        ↓
Gemini API：分析图层位置
        ↓
Gemini API：返回新位置方案
        ↓
后端：应用缩放方案
        ↓
后端：合成/重建图层
        ↓
后端：保存结果（PNG/PSD）
        ↓
返回结果URL
        ↓
前端：自动展示到画布
```

### WebSocket实时通信

```
前端 Socket.IO Client
        ↕
Socket.IO服务器（/socket.io）
        ↕
后端业务逻辑
        ↕
AI模型服务
```

---

## 🎨 UI组件结构

### 主要布局
```
App
├── CanvasHeader          # 顶部工具栏
│   ├── 文件菜单
│   ├── 编辑工具
│   └── 用户设置
├── CanvasExcali          # 主画布
│   ├── Excalidraw核心
│   ├── 图层管理
│   └── 工具面板
├── CanvasToolMenu        # 左侧工具栏
│   ├── PSD上传
│   ├── 智能缩放
│   ├── 图层编辑
│   └── 导出工具
├── PSDLayerSidebar       # 右侧图层面板
│   ├── 图层列表
│   ├── 图层操作
│   └── 属性编辑
└── ChatPanel             # AI聊天面板
    ├── 对话历史
    ├── 输入框
    └── 工具调用
```

---

## 🔍 性能优化

### 前端优化
1. **代码分割**: 使用Vite的动态导入
2. **懒加载**: React.lazy + Suspense
3. **虚拟列表**: 大量图层时使用虚拟滚动
4. **防抖节流**: 频繁操作优化
5. **图片优化**: Base64缓存，按需加载

### 后端优化
1. **异步处理**: 全面使用async/await
2. **文件流**: 大文件流式处理
3. **缓存策略**: Redis缓存（待实现）
4. **并发控制**: 限制并发请求
5. **临时文件清理**: 自动清理机制

---

## 🐛 已知问题和限制

### PSD处理限制
1. **psd-tools写入限制**
   - 无法直接创建多层PSD
   - 当前PSD模式实际返回PNG
   - 图层元数据保存在JSON

2. **文件大小限制**
   - 建议PSD < 100MB
   - 图层数 < 20个
   - 单层尺寸 < 4000×4000

### Gemini API限制
1. **配额限制**
   - 免费版有限制
   - 需要启用计费
   - 详见：`如何解决配额问题.md`

2. **处理时间**
   - 复杂PSD需1-2分钟
   - 网络延迟影响
   - 超时设置180秒

---

## 📈 未来规划

### 短期计划
- ⏳ 真正的多层PSD文件输出
- ⏳ 批量处理多个画布
- ⏳ 缩放历史记录
- ⏳ 预设尺寸模板

### 中期计划
- 💡 AI图层分组建议
- 💡 智能图层命名
- 💡 缩放预览功能
- 💡 撤销/重做支持

### 长期愿景
- 🌟 实时协作编辑
- 🌟 云端同步
- 🌟 插件系统
- 🌟 移动端支持

---

## 🧪 测试和质量保证

### 测试工具
- **单元测试**: Vitest
- **E2E测试**: Playwright
- **API测试**: 自定义测试脚本

### 测试文件
```
test_gemini_api.py          # Gemini API测试
test_psd_api.py             # PSD API测试
test_template_api.py        # 模板API测试
test_resize_by_id.py        # 缩放功能测试
```

---

## 📚 文档资源

### 用户文档
- `README.md` - 项目介绍
- `画布智能缩放快速指南.md` - 使用指南
- `HOW_TO_USE_LARGE_PSD.md` - 大文件处理

### 开发文档
- `画布智能缩放功能实现总结.md` - 技术文档
- `PSD_RESIZE_AUTO_CANVAS.md` - 自动展示功能
- `TEMPLATE_MANAGEMENT_SYSTEM.md` - 模板系统

### 故障排除
- `快速修复智能缩放.md` - 问题排查
- `如何解决配额问题.md` - API配额
- `GEMINI_API_TROUBLESHOOTING.md` - Gemini问题
- `Socket.IO問題修復說明.md` - WebSocket问题

---

## 🤝 贡献指南

### 代码规范
- **Python**: Black格式化
- **TypeScript**: ESLint + Prettier
- **提交**: Conventional Commits

### 开发流程
1. Fork项目
2. 创建特性分支
3. 编写代码和测试
4. 提交PR
5. 代码审查
6. 合并到主分支

---

## 📞 支持和联系

### 社区
- **Discord**: https://discord.gg/SMRe5n3m
- **GitHub**: https://github.com/11cafe/jaaz

### 商业支持
- **邮箱**: aifoxdw@gmail.com
- **微信**: aifox1

---

## 📄 许可证

开源项目，详见 LICENSE 文件

---

## 🎯 总结

**Jaaz** 是一个功能强大的开源设计工具，具有以下特点：

✅ **完整的技术栈**: Electron + React + FastAPI  
✅ **AI驱动**: Gemini、GPT、Midjourney等多模型支持  
✅ **PSD智能处理**: 上传、编辑、智能缩放  
✅ **无限画布**: 基于Excalidraw的强大画布  
✅ **隐私优先**: 本地运行，数据安全  
✅ **活跃开发**: 持续更新和改进  

**代码质量**: 良好的模块化设计，清晰的代码结构，完善的错误处理  
**可扩展性**: 插件化架构，易于添加新功能  
**文档完善**: 详细的用户和开发文档  

---

**分析完成时间**: 2025-10-29  
**分析版本**: v1.0.30  
**分析者**: AI Assistant





