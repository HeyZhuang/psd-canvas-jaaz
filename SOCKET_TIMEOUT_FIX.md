# Socket.IO è¶…æ—¶é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

å½“ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"æŒ‰é’®åï¼Œæ§åˆ¶å°å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
å¼€å§‹æ™ºèƒ½ç¼©æ”¾: {file_id: 'im_nCMlflGr', target_width: 800, target_height: 600, ...}
ğŸ”Œ Socket.IO disconnected: ping timeout
âŒ Socket.IO connection error: Error: timeout
```

åŒæ—¶å‡ºç°å¤§é‡ Socket.IO é‡è¿å°è¯•å’Œè¶…æ—¶é”™è¯¯ã€‚

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **æ™ºèƒ½ç¼©æ”¾å¤„ç†æ—¶é—´è¿‡é•¿**
   - éœ€è¦è°ƒç”¨ Gemini API åˆ†æå›¾å±‚
   - Gemini API å“åº”å¯èƒ½éœ€è¦ 30ç§’ - 2åˆ†é’Ÿ
   - è¶…è¿‡äº†é»˜è®¤çš„ HTTP å’Œ Socket.IO è¶…æ—¶æ—¶é—´

2. **å‰ç«¯è¯·æ±‚æœªè®¾ç½®è¶…æ—¶**
   - åŸä»£ç ä½¿ç”¨ `fetch` ä½†æ²¡æœ‰è®¾ç½® `signal` å’Œè¶…æ—¶æ§åˆ¶
   - æµè§ˆå™¨é»˜è®¤è¶…æ—¶å¯èƒ½åªæœ‰ 60ç§’

3. **Socket.IO æ¬¡è¦å½±å“**
   - Socket.IO ç”¨äºå®æ—¶é€šä¿¡ï¼Œä½†æ™ºèƒ½ç¼©æ”¾ä½¿ç”¨çš„æ˜¯ HTTP API
   - Socket.IO è¶…æ—¶ä¸å½±å“åŠŸèƒ½ï¼Œä½†ä¼šäº§ç”Ÿé”™è¯¯æ—¥å¿—

### ç½‘ç»œè¿æ¥çŠ¶æ€

```
TCP    127.0.0.1:57988    LISTENING       # æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
TCP    127.0.0.1:57988    CLOSE_WAIT      # å¤šä¸ªè¿æ¥å¤„äºå…³é—­ç­‰å¾…çŠ¶æ€
TCP    127.0.0.1:57988    FIN_WAIT_2      # å¤šä¸ªè¿æ¥å¤„äºç»“æŸç­‰å¾…çŠ¶æ€
```

è¿™äº› CLOSE_WAIT å’Œ FIN_WAIT_2 çŠ¶æ€è¡¨æ˜æœ‰å¾ˆå¤šè¿æ¥å› è¶…æ—¶è€Œå¼‚å¸¸å…³é—­ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. å¢åŠ  HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´

**ä¿®æ”¹æ–‡ä»¶**: 
- `react/src/components/canvas/menu/CanvasToolMenu.tsx`
- `react/src/components/canvas/PSDResizeDialog.tsx`

**ä¿®æ”¹å†…å®¹**:

```typescript
// âœ… ä½¿ç”¨ AbortController è®¾ç½® 180ç§’ è¶…æ—¶
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 180000) // 180ç§’è¶…æ—¶

try {
    const resizeResponse = await fetch('/api/psd/resize/resize-by-id', {
        method: 'POST',
        body: formData,
        signal: controller.signal,  // âœ… æ·»åŠ è¶…æ—¶ä¿¡å·
    })

    clearTimeout(timeoutId)
    
    // å¤„ç†å“åº”...
    
} catch (fetchError: any) {
    clearTimeout(timeoutId)
    
    if (fetchError.name === 'AbortError') {
        throw new Error('å¤„ç†è¶…æ—¶ï¼ˆè¶…è¿‡3åˆ†é’Ÿï¼‰ã€‚å¯èƒ½åŸå› ï¼š...')
    }
    throw fetchError
}
```

### 2. æ”¹è¿›ç”¨æˆ·æç¤º

**ä¿®æ”¹å‰**:
```typescript
setCurrentStep('æ­£åœ¨è°ƒç”¨Gemini APIåˆ†æå›¾å±‚...')
```

**ä¿®æ”¹å**:
```typescript
setCurrentStep('æ­£åœ¨è°ƒç”¨Gemini APIåˆ†æå›¾å±‚ï¼ˆè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿï¼‰...')
```

**ç”¨æˆ·ä½“éªŒæ”¹è¿›**:
- âœ… æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·éœ€è¦ç­‰å¾…æ—¶é—´
- âœ… é¿å…ç”¨æˆ·è¯¯ä»¥ä¸ºç¨‹åºå¡æ­»
- âœ… æä¾›æ›´å‹å¥½çš„è¶…æ—¶é”™è¯¯æç¤º

### 3. é”™è¯¯æç¤ºä¼˜åŒ–

**è¶…æ—¶é”™è¯¯æç¤º**:
```
å¤„ç†è¶…æ—¶ï¼ˆè¶…è¿‡3åˆ†é’Ÿï¼‰ã€‚å¯èƒ½åŸå› ï¼š
1. Gemini APIå“åº”æ…¢
2. å›¾å±‚æ•°é‡è¿‡å¤š
3. ç½‘ç»œè¿æ¥é—®é¢˜

è¯·ç¨åé‡è¯•æˆ–å‡å°‘å›¾å±‚æ•°é‡ã€‚
```

## æŠ€æœ¯ç»†èŠ‚

### è¶…æ—¶æ—¶é—´é€‰æ‹©

| æ“ä½œ | é¢„è®¡æ—¶é—´ | è®¾ç½®è¶…æ—¶ | åŸå›  |
|------|----------|----------|------|
| æ–‡ä»¶ä¸‹è½½ | 5-30ç§’ | 60ç§’ | å¤§æ–‡ä»¶ä¼ è¾“ |
| **æ™ºèƒ½ç¼©æ”¾** | **30-120ç§’** | **180ç§’** | **Gemini API å¤„ç†** |
| ä¸€èˆ¬ API | 1-5ç§’ | 30ç§’ | ç½‘ç»œå»¶è¿Ÿ |

### AbortController ä½¿ç”¨

```typescript
// åˆ›å»ºæ§åˆ¶å™¨
const controller = new AbortController()

// è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
const timeoutId = setTimeout(() => {
    controller.abort()  // è§¦å‘ä¸­æ­¢
}, 180000)

// ç»‘å®šåˆ° fetch
fetch(url, { signal: controller.signal })

// æ¸…ç†å®šæ—¶å™¨ï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½è¦æ¸…ç†ï¼‰
clearTimeout(timeoutId)

// æ•è·ä¸­æ­¢å¼‚å¸¸
catch (error) {
    if (error.name === 'AbortError') {
        // è¶…æ—¶å¤„ç†
    }
}
```

### ä¸ºä»€ä¹ˆæ˜¯ 180ç§’ï¼Ÿ

1. **Gemini API å¤„ç†æ—¶é—´**
   - å›¾å±‚åˆ†æï¼š10-30ç§’
   - AI ç”Ÿæˆä½ç½®ï¼š20-60ç§’
   - ç½‘ç»œå»¶è¿Ÿï¼š5-10ç§’
   - **æ€»è®¡ï¼š35-100ç§’**

2. **å®‰å…¨ä½™é‡**
   - è®¾ç½®ä¸º 180ç§’ï¼ˆ3åˆ†é’Ÿï¼‰
   - æä¾› 80-145ç§’ çš„ä½™é‡
   - é¿å…æ­£å¸¸è¯·æ±‚è¢«è¯¯åˆ¤ä¸ºè¶…æ—¶

3. **ç”¨æˆ·ä½“éªŒè€ƒè™‘**
   - 3åˆ†é’Ÿæ˜¯ç”¨æˆ·èƒ½æ¥å—çš„æœ€å¤§ç­‰å¾…æ—¶é—´
   - è¶…è¿‡3åˆ†é’Ÿï¼Œç”¨æˆ·ä¼šè®¤ä¸ºå‡ºé”™
   - æä¾›æ˜ç¡®çš„è¿›åº¦æç¤ºç¼“è§£ç„¦è™‘

## Socket.IO è¶…æ—¶è¯´æ˜

### Socket.IO æ˜¯å¦å½±å“åŠŸèƒ½ï¼Ÿ

**ä¸å½±å“**ã€‚æ™ºèƒ½ç¼©æ”¾ä½¿ç”¨çš„æ˜¯ HTTP APIï¼Œä¸ä¾èµ– Socket.IOï¼š

```
æ™ºèƒ½ç¼©æ”¾æµç¨‹:
å‰ç«¯ â†’ HTTP POST /api/psd/resize/resize-by-id â†’ åç«¯å¤„ç† â†’ è¿”å›ç»“æœ
       (ä¸ç»è¿‡ Socket.IO)
```

Socket.IO ä¸»è¦ç”¨äºï¼š
- å®æ—¶èŠå¤©ä¼šè¯
- å·¥å…·è°ƒç”¨è¿›åº¦æ¨é€
- æœåŠ¡å™¨çŠ¶æ€æ›´æ–°

### ä¸ºä»€ä¹ˆä¼šå‡ºç° Socket.IO è¶…æ—¶ï¼Ÿ

```
ç”¨æˆ·æ“ä½œ â†’ é¡µé¢é•¿æ—¶é—´ç­‰å¾… â†’ Socket.IO ping/pong è¶…æ—¶ â†’ è‡ªåŠ¨é‡è¿
```

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… å¢åŠ  HTTP è¯·æ±‚è¶…æ—¶ï¼ˆå·²ä¿®å¤ï¼‰
2. âŒ å¢åŠ  Socket.IO è¶…æ—¶ï¼ˆä¸æ¨èï¼Œä¼šæ©ç›–çœŸå®é—®é¢˜ï¼‰

Socket.IO è¶…æ—¶æ˜¯**ç—‡çŠ¶**ï¼Œä¸æ˜¯**åŸå› **ã€‚ä¿®å¤ HTTP è¶…æ—¶åï¼ŒSocket.IO é”™è¯¯ä¼šè‡ªç„¶æ¶ˆå¤±ã€‚

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

```bash
# 1. æµ‹è¯•å°æ–‡ä»¶ï¼ˆå›¾å±‚å°‘ï¼Œåº”è¯¥ < 30ç§’ï¼‰
curl -X POST http://localhost:57988/api/psd/resize/resize-by-id \
  -F "file_id=im_small123" \
  -F "target_width=800" \
  -F "target_height=600"

# 2. æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆå›¾å±‚å¤šï¼Œå¯èƒ½éœ€è¦ 60-120ç§’ï¼‰
curl -X POST http://localhost:57988/api/psd/resize/resize-by-id \
  -F "file_id=im_nCMlflGr" \
  -F "target_width=800" \
  -F "target_height=600"
```

### é¢„æœŸç»“æœ

**æˆåŠŸæƒ…å†µ**:
```
âœ… æ­£åœ¨å‡†å¤‡ç¼©æ”¾è¯·æ±‚...
âœ… æ­£åœ¨è°ƒç”¨Gemini APIåˆ†æå›¾å±‚ï¼ˆè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿï¼‰...
âœ… æ­£åœ¨å¤„ç†ç»“æœ...
âœ… ç¼©æ”¾å®Œæˆ
```

**è¶…æ—¶æƒ…å†µ**ï¼ˆè¶…è¿‡3åˆ†é’Ÿï¼‰:
```
âŒ å¤„ç†è¶…æ—¶ï¼ˆè¶…è¿‡3åˆ†é’Ÿï¼‰ã€‚å¯èƒ½åŸå› ï¼š
   1. Gemini APIå“åº”æ…¢
   2. å›¾å±‚æ•°é‡è¿‡å¤š
   3. ç½‘ç»œè¿æ¥é—®é¢˜
```

## å¯¹æ¯”æ€»ç»“

### ä¿®æ”¹å‰

| é—®é¢˜ | è¡¨ç° |
|------|------|
| è¶…æ—¶æ—¶é—´ | æµè§ˆå™¨é»˜è®¤ï¼ˆ~60ç§’ï¼‰ |
| è¶…æ—¶æç¤º | æ— ï¼Œæˆ–è€…æ˜¾ç¤º "Failed to fetch" |
| ç”¨æˆ·ç­‰å¾…æç¤º | "æ­£åœ¨è°ƒç”¨Gemini API..." |
| Socket.IO é”™è¯¯ | å¤§é‡è¶…æ—¶å’Œé‡è¿é”™è¯¯ |

### ä¿®æ”¹å

| æ”¹è¿› | è¡¨ç° |
|------|------|
| è¶…æ—¶æ—¶é—´ | **180ç§’ï¼ˆ3åˆ†é’Ÿï¼‰** âœ… |
| è¶…æ—¶æç¤º | **è¯¦ç»†çš„åŸå› å’Œå»ºè®®** âœ… |
| ç”¨æˆ·ç­‰å¾…æç¤º | **"è¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ"** âœ… |
| Socket.IO é”™è¯¯ | **ä¸ä¼šå†å‡ºç°ï¼ˆå› ä¸ºè¯·æ±‚ä¸ä¼šè¶…æ—¶ï¼‰** âœ… |

## ç›¸å…³æ–‡ä»¶

- âœ… `react/src/components/canvas/menu/CanvasToolMenu.tsx` - å·²ä¿®å¤
- âœ… `react/src/components/canvas/PSDResizeDialog.tsx` - å·²ä¿®å¤
- ğŸ“„ `PSD_LARGE_FILE_SOLUTION.md` - å¤§æ–‡ä»¶å¤„ç†æ–¹æ¡ˆ
- ğŸ“„ `HOW_TO_USE_LARGE_PSD.md` - ä½¿ç”¨æŒ‡å—

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æœåŠ¡ç«¯è¿›åº¦æ¨é€ï¼ˆå¯é€‰ï¼‰

å¯ä»¥é€šè¿‡ Socket.IO æ¨é€å®æ—¶è¿›åº¦ï¼š

```python
# æœåŠ¡ç«¯
await sio.emit('resize_progress', {
    'file_id': file_id,
    'step': 'extracting_layers',
    'progress': 30
})
```

```typescript
// å‰ç«¯ç›‘å¬
socket.on('resize_progress', (data) => {
    setProgress(data.progress)
    setCurrentStep(data.step)
})
```

### 2. ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¯é€‰ï¼‰

å¯¹äºè¶…å¤§æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨åå°ä»»åŠ¡ï¼š

```python
# åå°å¤„ç†
task_id = await create_resize_task(file_id, width, height)
return {'task_id': task_id, 'status': 'processing'}

# å‰ç«¯è½®è¯¢
while (status !== 'complete') {
    status = await fetch(`/api/psd/resize/status/${task_id}`)
    await sleep(2000)
}
```

### 3. ç¼“å­˜ç»“æœï¼ˆå¯é€‰ï¼‰

ç¼“å­˜ç›¸åŒå‚æ•°çš„ç¼©æ”¾ç»“æœï¼Œé¿å…é‡å¤å¤„ç†ï¼š

```python
cache_key = f"{file_id}_{target_width}_{target_height}"
if cache_key in cache:
    return cache[cache_key]
```

---

**é—®é¢˜å·²è§£å†³ï¼** ç°åœ¨æ™ºèƒ½ç¼©æ”¾åŠŸèƒ½å¯ä»¥æ­£å¸¸å¤„ç†é•¿æ—¶é—´çš„ Gemini API è°ƒç”¨äº†ã€‚ğŸ‰
