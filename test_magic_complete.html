<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”æ³•ç”ŸæˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }

        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .test-button:hover {
            background: #45a049;
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #ccc;
        }

        .checklist li.pass {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }

        .checklist li.fail {
            border-left-color: #f44336;
            background: #fef1f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” é­”æ³•ç”ŸæˆåŠŸèƒ½å®Œæ•´æµ‹è¯•</h1>

        <div class="test-section">
            <h2>1. ç³»ç»Ÿæ£€æŸ¥</h2>
            <button class="test-button" onclick="checkSystem()">è¿è¡Œç³»ç»Ÿæ£€æŸ¥</button>
            <div id="system-result"></div>
        </div>

        <div class="test-section">
            <h2>2. åç«¯APIæµ‹è¯•</h2>
            <button class="test-button" onclick="testBackendAPI()">æµ‹è¯• /api/magic</button>
            <button class="test-button" onclick="testCanvasAPI()">æµ‹è¯• /api/canvas/default</button>
            <div id="backend-result"></div>
        </div>

        <div class="test-section">
            <h2>3. å‰ç«¯ç¯å¢ƒæ£€æŸ¥</h2>
            <button class="test-button" onclick="checkFrontend()">æ£€æŸ¥å‰ç«¯ç¯å¢ƒ</button>
            <div id="frontend-result"></div>
        </div>

        <div class="test-section">
            <h2>4. æ¨¡æ‹Ÿé­”æ³•ç”Ÿæˆäº‹ä»¶</h2>
            <button class="test-button" onclick="simulateMagicEvent()">å‘é€æµ‹è¯•äº‹ä»¶</button>
            <div id="event-result"></div>
        </div>

        <div class="test-section">
            <h2>5. æ£€æŸ¥æ¸…å•</h2>
            <ul class="checklist" id="checklist">
                <li>â³ åç«¯æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€</li>
                <li>â³ å‰ç«¯æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€</li>
                <li>â³ APIè¿æ¥æµ‹è¯•</li>
                <li>â³ é€‰ä¸­å…ƒç´ æ•°é‡ (éœ€è¦ â‰¥2)</li>
                <li>â³ ç™»å½•çŠ¶æ€</li>
                <li>â³ EventBuså¯ç”¨æ€§</li>
                <li>â³ excalidrawAPIåˆå§‹åŒ–</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>6. ä½¿ç”¨è¯´æ˜</h2>
            <div class="info result">
                <strong>å¦‚ä½•ä½¿ç”¨é­”æ³•ç”ŸæˆåŠŸèƒ½:</strong>

                1. åœ¨ç”»å¸ƒä¸Šé€‰ä¸­è‡³å°‘2ä¸ªå…ƒç´ ï¼ˆå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼šæ–‡æœ¬ã€å½¢çŠ¶ã€å›¾ç‰‡ç­‰ï¼‰
                2. ç¡®ä¿å·²ç™»å½•
                3. ç‚¹å‡»å¼¹å‡ºçš„"é­”æ³•ç”Ÿæˆ"æŒ‰é’®ï¼Œæˆ–æŒ‰å¿«æ·é”® Ctrl+B (Windows) / âŒ˜+B (Mac)
                4. ç­‰å¾…AIåˆ†æå’Œç”Ÿæˆç»“æœ

                <strong>å¦‚æœæ²¡æœ‰ååº”:</strong>

                1. æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†è‡³å°‘2ä¸ªå…ƒç´ 
                2. ç¡®è®¤"é­”æ³•ç”Ÿæˆ"æŒ‰é’®æ˜¯å¦æ˜¾ç¤º
                3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12) æŸ¥çœ‹Consoleæ˜¯å¦æœ‰é”™è¯¯
                4. æŸ¥çœ‹Networkæ ‡ç­¾æ˜¯å¦æœ‰ /api/magic è¯·æ±‚
                5. è¿è¡Œæœ¬é¡µé¢çš„æµ‹è¯•å·¥å…·è¿›è¡Œè¯Šæ–­
            </div>
        </div>
    </div>

    <script>
        async function checkSystem() {
            const result = document.getElementById('system-result');
            result.innerHTML = '<div class="info result">æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿ...</div>';

            const checks = [];

            // æ£€æŸ¥åç«¯
            try {
                const backendRes = await fetch('/api/canvas/list');
                checks.push({
                    name: 'åç«¯æœåŠ¡å™¨',
                    status: backendRes.ok,
                    message: backendRes.ok ? 'âœ… æ­£å¸¸è¿è¡Œ' : `âŒ é”™è¯¯: ${backendRes.status}`
                });
            } catch (e) {
                checks.push({
                    name: 'åç«¯æœåŠ¡å™¨',
                    status: false,
                    message: `âŒ æ— æ³•è¿æ¥: ${e.message}`
                });
            }

            // æ£€æŸ¥EventBus
            checks.push({
                name: 'EventBus',
                status: !!window.eventBus,
                message: window.eventBus ? 'âœ… å·²åŠ è½½' : 'âŒ æœªæ‰¾åˆ°'
            });

            // æ˜¾ç¤ºç»“æœ
            let html = '<ul class="checklist">';
            checks.forEach(check => {
                html += `<li class="${check.status ? 'pass' : 'fail'}">${check.name}: ${check.message}</li>`;
            });
            html += '</ul>';
            result.innerHTML = html;

            updateChecklist();
        }

        async function testBackendAPI() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<div class="info result">æ­£åœ¨æµ‹è¯•åç«¯API...</div>';

            try {
                const response = await fetch('/api/magic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: [{ type: 'text', text: 'test' }]
                        }],
                        session_id: 'test-' + Date.now(),
                        canvas_id: 'test',
                        system_prompt: 'test'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `<div class="success result">âœ… APIæµ‹è¯•æˆåŠŸ!\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}</div>`;
                } else {
                    result.innerHTML = `<div class="error result">âŒ APIé”™è¯¯\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error result">âŒ è¯·æ±‚å¤±è´¥:\n${error.message}\n\nè¯·ç¡®è®¤:\n1. åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ\n2. ç«¯å£é…ç½®æ˜¯å¦æ­£ç¡®</div>`;
            }
        }

        async function testCanvasAPI() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<div class="info result">æ­£åœ¨æµ‹è¯•Canvas API...</div>';

            try {
                const response = await fetch('/api/canvas/default');
                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `<div class="success result">âœ… Canvas APIæ­£å¸¸!\nçŠ¶æ€ç : ${response.status}\nç”»å¸ƒåç§°: ${data.name}\nä¼šè¯æ•°: ${data.sessions?.length || 0}</div>`;
                } else {
                    result.innerHTML = `<div class="error result">âŒ Canvas APIé”™è¯¯\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error result">âŒ è¯·æ±‚å¤±è´¥:\n${error.message}</div>`;
            }
        }

        function checkFrontend() {
            const result = document.getElementById('frontend-result');

            const checks = [];

            // æ£€æŸ¥EventBus
            checks.push({
                name: 'EventBus',
                status: !!window.eventBus,
                details: window.eventBus ? 'å·²åŠ è½½' : 'æœªæ‰¾åˆ° - å¯èƒ½é¡µé¢æœªå®Œå…¨åŠ è½½'
            });

            // æ£€æŸ¥localStorage
            checks.push({
                name: 'LocalStorage',
                status: !!window.localStorage,
                details: window.localStorage ? 'å¯ç”¨' : 'ä¸å¯ç”¨'
            });

            // æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„é¡µé¢
            const isCanvasPage = window.location.pathname.includes('/canvas/');
            checks.push({
                name: 'å½“å‰é¡µé¢',
                status: isCanvasPage,
                details: isCanvasPage ? `ç”»å¸ƒé¡µé¢: ${window.location.pathname}` : 'éç”»å¸ƒé¡µé¢ - è¯·åœ¨ç”»å¸ƒé¡µé¢æµ‹è¯•'
            });

            let html = '<ul class="checklist">';
            checks.forEach(check => {
                html += `<li class="${check.status ? 'pass' : 'fail'}">${check.name}: ${check.details}</li>`;
            });
            html += '</ul>';
            result.innerHTML = html;
        }

        function simulateMagicEvent() {
            const result = document.getElementById('event-result');

            if (!window.eventBus) {
                result.innerHTML = '<div class="error result">âŒ EventBusæœªæ‰¾åˆ°!\n\nè¯·åœ¨ç”»å¸ƒé¡µé¢ (http://localhost:3000/canvas/default) æ‰“å¼€æ­¤æµ‹è¯•é¡µé¢ã€‚</div>';
                return;
            }

            const testEvent = {
                fileId: 'test-' + Date.now(),
                base64: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                width: 100,
                height: 100,
                timestamp: new Date().toISOString()
            };

            console.log('ğŸ“¤ å‘é€æµ‹è¯•äº‹ä»¶:', testEvent);

            try {
                window.eventBus.emit('Canvas::MagicGenerate', testEvent);
                result.innerHTML = `<div class="success result">âœ… äº‹ä»¶å·²å‘é€!\n\nè¯·æ£€æŸ¥:\n1. èŠå¤©ç•Œé¢æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯\n2. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰"é­”æ³•ç”Ÿæˆæ¶ˆæ¯å·²å‘é€åˆ°åå°"\n3. Networkæ ‡ç­¾æ˜¯å¦æœ‰ /api/magic è¯·æ±‚\n\näº‹ä»¶æ•°æ®:\n${JSON.stringify(testEvent, null, 2)}</div>`;
            } catch (error) {
                result.innerHTML = `<div class="error result">âŒ å‘é€äº‹ä»¶å¤±è´¥:\n${error.message}\n\n${error.stack}</div>`;
            }
        }

        function updateChecklist() {
            // è¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨å®é™…åº”ç”¨ä¸­æ›´æ–°æ£€æŸ¥æ¸…å•çŠ¶æ€
            console.log('Checklist updated');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç³»ç»Ÿæ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(checkSystem, 500);
        });
    </script>
</body>

</html>