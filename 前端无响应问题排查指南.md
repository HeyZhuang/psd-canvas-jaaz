# 前端页面一直转圈问题排查指南

## 问题现象
访问 http://localhost:3100/canvas/default 时，页面一直显示加载动画（转圈），无法加载内容。

## 已确认正常的部分
✅ 前端服务器运行正常 (端口 3100)
✅ 后端服务器运行正常 (端口 58000)  
✅ 后端API响应正常
✅ Vite dev server正常
✅ HTML和JavaScript文件可以正常加载

## 诊断步骤

### 1. 使用诊断页面（推荐）

在浏览器中打开诊断页面：
```
http://localhost:3100/diagnose_frontend.html
```

该页面会自动测试所有关键连接点，并显示详细结果。

### 2. 手动检查浏览器控制台

#### 操作步骤：
1. 打开 Chrome/Edge/Firefox 浏览器
2. 访问 `http://localhost:3100/canvas/default`
3. 按 **F12** 打开开发者工具
4. 切换到 **Console** 标签

#### 查看什么：
- 🔴 **红色错误信息** - 表示JavaScript执行错误
- 🟡 **黄色警告** - 可能影响功能
- 🔵 **蓝色信息** - 正常日志

#### 常见错误及解决方案：

**错误1: `Failed to fetch` 或 `Network Error`**
```
解决方案：后端API未正确代理
→ 检查 vite.config.ts 中的 proxy 配置
→ 确保后端在 localhost:58000 运行
→ 重启前端服务
```

**错误2: `Module not found` 或 `Cannot resolve module`**
```
解决方案：依赖模块缺失
→ cd /home/ubuntu/jaaz/react
→ npm install
→ ./restart_frontend.sh
```

**错误3: `Socket.IO connection timeout`**
```
解决方案：Socket.IO连接失败（不影响基本功能）
→ 这是正常的，Socket.IO是可选功能
→ 页面应该继续加载，如果卡住则是其他问题
```

**错误4: `Uncaught TypeError`**
```
解决方案：代码执行错误
→ 查看完整错误堆栈
→ 检查是否是某个组件初始化失败
→ 可能需要清除浏览器缓存 (Ctrl+Shift+Delete)
```

### 3. 检查网络请求

#### 操作步骤：
1. 开发者工具中切换到 **Network** 标签
2. 刷新页面 (F5)
3. 查看所有网络请求

#### 重点检查：

**关键请求1: `/api/canvas/default`**
```
期望状态: 200 OK
如果失败:
  - 404: Canvas不存在（正常，会创建默认canvas）
  - 500: 后端错误，检查后端日志
  - CORS错误: proxy配置问题
  - Timeout: 后端响应慢或卡住
```

**关键请求2: `/src/main.tsx` 和其他 `.tsx` 文件**
```
期望状态: 200 OK
如果失败:
  - 404: 文件不存在，检查文件路径
  - 500: Vite编译错误，查看终端输出
```

**关键请求3: `/node_modules/.vite/deps/...`**
```
期望状态: 200 OK
如果大量失败:
  - 删除 node_modules/.vite 文件夹
  - 重启前端服务
```

### 4. 测试API连接

在浏览器控制台中执行以下代码：

```javascript
// 测试后端API
fetch('/api/config')
  .then(r => r.json())
  .then(d => console.log('✅ API正常:', d))
  .catch(e => console.error('❌ API错误:', e));

// 测试Canvas API
fetch('/api/canvas/default')
  .then(r => r.json())
  .then(d => console.log('✅ Canvas API正常:', d))
  .catch(e => console.error('❌ Canvas API错误:', e));
```

### 5. 清除缓存重试

浏览器缓存可能导致问题：

```bash
# 方法1: 硬刷新（推荐）
Ctrl + Shift + R  (Windows/Linux)
Cmd + Shift + R   (Mac)

# 方法2: 清除缓存
1. 按 F12 打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

# 方法3: 隐私模式测试
Ctrl + Shift + N (Chrome/Edge)
Ctrl + Shift + P (Firefox)
```

## 快速修复方案

### 方案1: 重启所有服务

```bash
# 进入项目目录
cd /home/ubuntu/jaaz

# 重启后端
./restart_backend.sh

# 等待3秒
sleep 3

# 重启前端
./restart_frontend.sh

# 等待前端启动完成后访问
# http://localhost:3100/canvas/default
```

### 方案2: 重新安装依赖

```bash
# 进入前端目录
cd /home/ubuntu/jaaz/react

# 清理缓存
rm -rf node_modules/.vite
rm -rf dist

# 重新安装（如果怀疑依赖问题）
# npm install

# 重启前端
cd /home/ubuntu/jaaz
./restart_frontend.sh
```

### 方案3: 检查端口冲突

```bash
# 检查3100端口
lsof -i :3100

# 检查58000端口  
lsof -i :58000

# 如果有其他进程占用，先kill掉
kill <PID>
```

## 已知问题

### Socket.IO连接超时
**现象**：控制台显示 Socket.IO 连接错误  
**影响**：不影响基本功能，只影响实时协作  
**解决**：可以忽略，或确保后端Socket.IO服务正常

### PostHog分析服务
**现象**：PostHog相关警告  
**影响**：不影响功能  
**解决**：可以忽略

### 浏览器扩展冲突
**现象**：`runtime.lastError` 相关错误  
**影响**：已经被过滤，不影响功能  
**解决**：禁用浏览器扩展测试

## 下一步操作

如果以上方法都无法解决问题，请：

1. **截图控制台错误**（完整的错误堆栈）
2. **截图Network标签**（失败的请求）
3. **提供前端终端输出**：
   ```bash
   ps aux | grep vite
   tail -50 /tmp/jaaz_frontend.log  # 如果有的话
   ```
4. **提供后端日志**：
   ```bash
   tail -100 /home/ubuntu/jaaz/server/backend.log
   ```

## 验证问题是否解决

在浏览器中访问诊断页面：
```
http://localhost:3100/diagnose_frontend.html
```

所有测试项应显示绿色 ✅ 标记。

然后访问实际页面：
```
http://localhost:3100/canvas/default
```

应该能看到画布界面，不再转圈。





