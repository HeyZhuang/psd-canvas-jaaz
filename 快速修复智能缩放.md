# 🔧 智能缩放功能快速修复指南

## ✅ 诊断结果

经过系统检查，发现以下状态：

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 后端服务器 | ✅ 正常 | 运行在 127.0.0.1:57988 |
| 前端代理 | ✅ 正常 | 代理配置正确 |
| **Gemini API 密钥** | ❌ **缺失** | **这是问题所在！** |
| PSD 文件 | ✅ 正常 | 已上传 22 个文件 |

## 🎯 问题根源

**您没有配置有效的 Gemini API 密钥**，这导致前端无法调用 Gemini AI 进行智能缩放分析。

## 🚀 解决方案（3种方式）

### 方式 1️⃣：在对话框中直接输入（推荐）

1. 获取 API 密钥：
   - 访问：https://aistudio.google.com/apikey
   - 点击 "Get API key" 或 "创建 API 密钥"
   - 复制生成的密钥（类似 `AIzaSy...`）

2. 在智能缩放对话框中：
   - 找到 "Gemini API密钥 (可选)" 输入框
   - **粘贴您的 API 密钥**
   - 点击 "开始智能缩放"

### 方式 2️⃣：配置到环境文件

```bash
# 在项目根目录创建 config.env 文件
cd /home/ubuntu/jaaz
echo 'GEMINI_API_KEY=您的实际API密钥' > config.env

# 重启后端服务器
# 按 Ctrl+C 停止当前服务器
# 然后重新运行: python server/main.py
```

### 方式 3️⃣：设置环境变量

```bash
# 临时设置（当前会话有效）
export GEMINI_API_KEY="您的实际API密钥"

# 或永久设置（添加到 ~/.bashrc）
echo 'export GEMINI_API_KEY="您的实际API密钥"' >> ~/.bashrc
source ~/.bashrc
```

## 📝 详细步骤

### 1. 获取 Gemini API 密钥

1. **访问 Google AI Studio**
   ```
   https://aistudio.google.com/apikey
   ```

2. **登录 Google 账号**
   - 使用您的 Google 账号登录

3. **创建 API 密钥**
   - 点击 "Create API key" 按钮
   - 选择项目（或创建新项目）
   - 复制生成的 API 密钥

4. **API 密钥格式**
   ```
   AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
   ```

### 2. 使用 API 密钥

**最简单的方式**：在智能缩放对话框中输入

```
1. 上传 PSD 文件
2. 点击 "智能缩放" 按钮
3. 设置目标尺寸（例如 960 x 270）
4. 在 "Gemini API密钥" 输入框中粘贴您的密钥  ← 关键步骤！
5. 点击 "开始智能缩放"
```

## ⚠️ 重要提示

### API 配额限制

Gemini API 免费版有以下限制：
- **每分钟**: 15 次请求
- **每天**: 1,500 次请求

如果超过配额，您会看到错误：
```
Gemini API 配额已用尽
```

**解决方法**：
1. 等待几分钟后重试
2. 查看配额使用情况：https://ai.dev/usage?tab=rate-limit
3. 考虑升级到付费计划

### 测试 API 密钥是否有效

```bash
# 使用 curl 测试（替换 YOUR_API_KEY）
curl "https://generativelanguage.googleapis.com/v1beta/models?key=YOUR_API_KEY"

# 如果返回模型列表，说明密钥有效
# 如果返回错误，说明密钥无效或已过期
```

## 🎊 验证修复

配置 API 密钥后，执行以下步骤验证：

1. **刷新浏览器页面**
   - 按 F5 或 Ctrl+R

2. **重新尝试智能缩放**
   - 上传 PSD 文件（或使用已上传的）
   - 设置目标尺寸
   - 输入 API 密钥（如果使用方式 1）
   - 点击 "开始智能缩放"

3. **观察进度**
   ```
   ✅ 10% 正在准备缩放请求...
   ✅ 30% 正在调用 Gemini API 分析图层...  ← 应该能通过这一步
   ✅ 90% 正在处理结果...
   ✅ 95% 正在添加图片到画布...
   ✅ 100% 缩放完成
   ```

## 🐛 常见错误

### 错误 1：无法连接到后端服务器

**原因**：API 密钥未配置，Gemini API 调用失败

**解决**：按上述方式配置 API 密钥

### 错误 2：API key not valid

**原因**：API 密钥无效或格式错误

**解决**：
1. 检查密钥是否完整复制
2. 确认密钥未过期
3. 重新生成新的 API 密钥

### 错误 3：RESOURCE_EXHAUSTED / 429

**原因**：API 配额已用尽

**解决**：
1. 等待几分钟
2. 检查配额：https://ai.dev/usage?tab=rate-limit
3. 考虑升级到付费计划

## 📚 相关文档

- **Gemini API 文档**: https://ai.google.dev/docs
- **API 密钥管理**: https://aistudio.google.com/apikey
- **配额管理**: https://ai.dev/usage?tab=rate-limit
- **定价信息**: https://ai.google.dev/pricing

## 💡 额外提示

### 保护您的 API 密钥

⚠️ **不要**将 API 密钥提交到 Git 仓库！

```bash
# 将 config.env 添加到 .gitignore
echo "config.env" >> .gitignore
```

### 使用专用项目

建议为这个项目创建专门的 Google Cloud 项目，以便：
- 独立管理配额
- 监控 API 使用情况
- 避免影响其他项目

---

**如有问题，请查看浏览器控制台（F12）的详细错误信息。**

