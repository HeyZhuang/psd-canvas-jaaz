# PSDæ™ºèƒ½ç¼©æ”¾206çŠ¶æ€ç é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"æŒ‰é’®åï¼Œå‰ç«¯å‘å‡ºè¯·æ±‚åˆ° `http://localhost:57988/api/psd/file/{file_id}`ï¼Œè¿”å›çŠ¶æ€ç 206ï¼ˆPartial Contentï¼‰ï¼Œå¯¼è‡´å‰ç«¯æŠ¥é”™ï¼š"Failed to fetch"ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **HTTP 206çŠ¶æ€ç **ï¼šæœåŠ¡å™¨è¿”å›206ï¼ˆPartial Contentï¼‰æ˜¯å› ä¸ºï¼š
   - æµè§ˆå™¨è‡ªåŠ¨å‘é€äº†Rangeè¯·æ±‚å¤´
   - `FileResponse` é»˜è®¤æ”¯æŒRangeè¯·æ±‚
   - è¿™å¯¼è‡´è¿”å›éƒ¨åˆ†å†…å®¹è€Œä¸æ˜¯å®Œæ•´æ–‡ä»¶

2. **å‰ç«¯fetchå¤±è´¥**ï¼š
   - å‰ç«¯ä»£ç æœªå¤„ç†206çŠ¶æ€ç 
   - åªæ£€æŸ¥äº† `response.ok`ï¼ˆ200-299èŒƒå›´ï¼‰
   - 206è™½ç„¶åœ¨æ­¤èŒƒå›´å†…ï¼Œä½†æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´blobå¤„ç†å¤±è´¥

3. **æ–‡ä»¶ä¸‹è½½æµç¨‹**ï¼š
   ```
   å‰ç«¯ â†’ è¯·æ±‚PSDæ–‡ä»¶ â†’ åç«¯è¿”å›206 â†’ å‰ç«¯å°è¯•è½¬blob â†’ å¤±è´¥
   ```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åç«¯ç¦ç”¨Rangeè¯·æ±‚ï¼ˆå·²å®æ–½ï¼‰

**æ–‡ä»¶**: `server/routers/psd_router.py`

```python
@router.get("/file/{file_id}")
async def get_psd_file(file_id: str):
    """è·å–åŸå§‹PSDæ–‡ä»¶"""
    file_path = os.path.join(PSD_DIR, f'{file_id}.psd')
    if not os.path.exists(file_path):
        raise HTTPException(status_code=404, detail="PSD file not found")
    
    # ç¦ç”¨Rangeè¯·æ±‚ï¼Œç¡®ä¿è¿”å›å®Œæ•´æ–‡ä»¶
    return FileResponse(
        file_path,
        media_type='application/octet-stream',
        headers={
            'Accept-Ranges': 'none',  # ç¦ç”¨Rangeè¯·æ±‚
            'Content-Disposition': f'inline; filename="{file_id}.psd"'
        }
    )
```

**ä¼˜ç‚¹**:
- âœ… æœåŠ¡å™¨ç›´æ¥è¿”å›200çŠ¶æ€ç å’Œå®Œæ•´æ–‡ä»¶
- âœ… é¿å…Rangeè¯·æ±‚ç›¸å…³é—®é¢˜
- âœ… ç®€å•ç›´æ¥

**ç¼ºç‚¹**:
- âš ï¸ å¤§æ–‡ä»¶æ— æ³•æ–­ç‚¹ç»­ä¼ 
- âš ï¸ ç½‘ç»œä¸ç¨³å®šæ—¶å¯èƒ½éœ€è¦é‡æ–°ä¸‹è½½

### æ–¹æ¡ˆ2: å‰ç«¯å…¼å®¹206çŠ¶æ€ç ï¼ˆå·²å®æ–½ï¼‰

**æ–‡ä»¶**: 
- `react/src/components/canvas/PSDResizeDialog.tsx`
- `react/src/components/canvas/menu/CanvasToolMenu.tsx`

```typescript
const response = await fetch(psdData.url, {
    method: 'GET',
    headers: {
        // ç¦ç”¨Rangeè¯·æ±‚ï¼Œç¡®ä¿è·å–å®Œæ•´æ–‡ä»¶
        'Range': '',
    }
})

// æ”¯æŒ200å’Œ206çŠ¶æ€ç 
if (!response.ok && response.status !== 206) {
    throw new Error(`ä¸‹è½½PSDæ–‡ä»¶å¤±è´¥: HTTP ${response.status}`)
}

const blob = await response.blob()

// éªŒè¯blobå¤§å°
if (blob.size === 0) {
    throw new Error('PSDæ–‡ä»¶ä¸ºç©ºï¼Œè¯·é‡æ–°ä¸Šä¼ ')
}
```

**æ”¹è¿›ç‚¹**:
- âœ… æ˜¾å¼è®¾ç½®ç©ºRangeå¤´ï¼Œç¦ç”¨Rangeè¯·æ±‚
- âœ… å…¼å®¹200å’Œ206çŠ¶æ€ç 
- âœ… éªŒè¯ä¸‹è½½çš„blobå¤§å°
- âœ… æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
- âœ… æ›´ç»†è‡´çš„è¿›åº¦åé¦ˆ
- âœ… æ·»åŠ æ§åˆ¶å°æ—¥å¿—æ–¹ä¾¿è°ƒè¯•

## ğŸ“Š å®Œæ•´ä¿®å¤æµç¨‹

### 1. ç”¨æˆ·æ“ä½œæµç¨‹

```
ç”¨æˆ·ä¸Šä¼ PSDæ–‡ä»¶
    â†“
ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"
    â†“
å‰ç«¯è¯·æ±‚ä¸‹è½½PSDæ–‡ä»¶ (/api/psd/file/{file_id})
    â†“
åç«¯è¿”å›å®Œæ•´æ–‡ä»¶ï¼ˆ200çŠ¶æ€ç ï¼‰
    â†“
å‰ç«¯è½¬æ¢ä¸ºblobå¹¶éªŒè¯
    â†“
åˆ›å»ºFormDataä¸Šä¼ åˆ°ç¼©æ”¾API
    â†“
è°ƒç”¨Gemini APIè¿›è¡Œæ™ºèƒ½åˆ†æ
    â†“
è¿”å›ç¼©æ”¾ç»“æœ
```

### 2. é”™è¯¯å¤„ç†æ”¹è¿›

#### ä¸‹è½½é˜¶æ®µ
- âœ… æ£€æŸ¥HTTPçŠ¶æ€ç ï¼ˆæ”¯æŒ200å’Œ206ï¼‰
- âœ… éªŒè¯blobå¤§å°ä¸ä¸º0
- âœ… æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

#### ç¼©æ”¾é˜¶æ®µ
- âœ… æ•è·å¹¶æ˜¾ç¤ºAPIé”™è¯¯
- âœ… å¤„ç†ç½‘ç»œé”™è¯¯
- âœ… æ·»åŠ æ§åˆ¶å°æ—¥å¿—

#### è¿›åº¦åé¦ˆ
- 10%: æ­£åœ¨ä¸‹è½½PSDæ–‡ä»¶
- 20%: æ­£åœ¨å‡†å¤‡ç¼©æ”¾è¯·æ±‚
- 30%: æ­£åœ¨è°ƒç”¨Gemini API
- 90%: æ­£åœ¨å¤„ç†ç»“æœ
- 100%: ç¼©æ”¾å®Œæˆ

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1: å°æ–‡ä»¶ï¼ˆ< 10MBï¼‰
```
1. ä¸Šä¼ å°PSDæ–‡ä»¶
2. ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"
3. éªŒè¯ï¼šæ­£å¸¸ä¸‹è½½å¹¶ç¼©æ”¾
```

### æµ‹è¯•åœºæ™¯2: å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼‰
```
1. ä¸Šä¼ å¤§PSDæ–‡ä»¶
2. ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"
3. éªŒè¯ï¼šå®Œæ•´ä¸‹è½½åå†ç¼©æ”¾
```

### æµ‹è¯•åœºæ™¯3: ç½‘ç»œä¸ç¨³å®š
```
1. é™åˆ¶ç½‘ç»œé€Ÿåº¦
2. æ‰§è¡Œç¼©æ”¾æ“ä½œ
3. éªŒè¯ï¼šé”™è¯¯æç¤ºæ¸…æ™°
```

## ğŸ”§ è°ƒè¯•æ–¹æ³•

### æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Networkæ ‡ç­¾ï¼š

1. **æŸ¥çœ‹PSDä¸‹è½½è¯·æ±‚**
   - URL: `/api/psd/file/{file_id}`
   - æœŸæœ›çŠ¶æ€ç : 200ï¼ˆä¿®å¤åï¼‰
   - åŸçŠ¶æ€ç : 206ï¼ˆä¿®å¤å‰ï¼‰

2. **æŸ¥çœ‹Response Headers**
   ```
   Accept-Ranges: none
   Content-Type: application/octet-stream
   Content-Disposition: inline; filename="xxx.psd"
   ```

3. **æŸ¥çœ‹Request Headers**
   ```
   Range: (åº”è¯¥ä¸ºç©ºæˆ–ä¸å­˜åœ¨)
   ```

### æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

```javascript
// ä¿®å¤åä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
console.error('PSDç¼©æ”¾é”™è¯¯:', err)
```

## ğŸ“ ç›¸å…³ä»£ç ä½ç½®

### åç«¯ä¿®æ”¹
- `server/routers/psd_router.py` (ç¬¬241è¡Œ)
  - `get_psd_file()` å‡½æ•°

### å‰ç«¯ä¿®æ”¹
- `react/src/components/canvas/PSDResizeDialog.tsx` (ç¬¬30-77è¡Œ)
  - `handleResize()` å‡½æ•°
  
- `react/src/components/canvas/menu/CanvasToolMenu.tsx` (ç¬¬249-332è¡Œ)
  - `handleResize()` å‡½æ•°

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - PSDæ–‡ä»¶å»ºè®® < 50MB
   - è¶…å¤§æ–‡ä»¶å¯èƒ½å¯¼è‡´è¶…æ—¶

2. **æµè§ˆå™¨å…¼å®¹æ€§**
   - æµ‹è¯•äº†Chromeã€Edgeã€Firefox
   - Safariå¯èƒ½æœ‰ä¸åŒè¡¨ç°

3. **ç½‘ç»œç¨³å®šæ€§**
   - å»ºè®®åœ¨ç¨³å®šç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨
   - å¤±è´¥åå¯é‡è¯•

## ğŸ‰ ä¿®å¤æ•ˆæœ

ä¿®å¤åçš„é¢„æœŸè¡¨ç°ï¼š

âœ… **æ­£å¸¸æµç¨‹**:
```
ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"
â†’ "æ­£åœ¨ä¸‹è½½PSDæ–‡ä»¶..." (10%)
â†’ "æ­£åœ¨å‡†å¤‡ç¼©æ”¾è¯·æ±‚..." (20%)
â†’ "æ­£åœ¨è°ƒç”¨Gemini API..." (30%)
â†’ "æ­£åœ¨å¤„ç†ç»“æœ..." (90%)
â†’ "ç¼©æ”¾å®Œæˆ" (100%)
â†’ æ˜¾ç¤ºç»“æœï¼Œå¯ä¸‹è½½
```

âœ… **é”™è¯¯å¤„ç†**:
```
ä¸‹è½½å¤±è´¥ â†’ "ä¸‹è½½PSDæ–‡ä»¶å¤±è´¥: HTTP 404"
APIå¤±è´¥ â†’ "ç¼©æ”¾å¤±è´¥: APIå¯†é’¥æ— æ•ˆ"
ç½‘ç»œé”™è¯¯ â†’ "ç¼©æ”¾å¤±è´¥: Failed to fetch"
```

## ğŸ“ åç»­æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼š

1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰çš„Networkå’ŒConsoleæ ‡ç­¾
2. ç¡®è®¤PSDæ–‡ä»¶å·²æˆåŠŸä¸Šä¼ 
3. éªŒè¯Gemini APIå¯†é’¥é…ç½®æ­£ç¡®
4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-24  
**ä¿®å¤ç‰ˆæœ¬**: v1.0.1  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•
