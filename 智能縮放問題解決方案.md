# 智能縮放「無法連接到後端服務器」問題解決方案

## 問題描述
當使用智能縮放功能時，頁面報錯：
```
無法連接到後端服務器。請確保：
1. 後端服務器已啟動
2. API路徑正確
3. 網路連接正常
```

## ✅ 已驗證的服務狀態

根據診斷結果，您的服務配置**完全正確**：

- ✅ 前端運行在 **3100** 端口
- ✅ 後端運行在 **58000** 端口  
- ✅ API代理工作正常
- ✅ Gemini API密鑰已配置
- ✅ 所有PSD縮放端點可用

## 🔍 問題根源

這個錯誤通常是由以下原因之一引起的：

### 1. 瀏覽器緩存問題
前端代碼可能沒有正確加載最新版本。

**解決方案：**
```bash
# 在瀏覽器中硬刷新
Ctrl+Shift+R (Windows/Linux)
Cmd+Shift+R (Mac)

# 或者清除瀏覽器緩存後重新訪問
http://localhost:3100/canvas/default
```

### 2. 前端服務需要重啟
前端進程可能在某個時刻被終止或未正確啟動。

**解決方案：**
```bash
cd /home/ubuntu/jaaz
./restart_frontend.sh

# 等待3-5秒後訪問
http://localhost:3100/canvas/default
```

### 3. 開發環境模式問題
Vite可能未在開發模式下運行，導致代理未生效。

**解決方案：**
```bash
# 停止前端
pkill -f "jaaz/react.*vite"

# 手動啟動（確保在開發模式）
cd /home/ubuntu/jaaz/react
npm run dev
```

### 4. 端口被其他服務佔用
雖然診斷顯示端口正常，但可能存在間歇性衝突。

**檢查方法：**
```bash
# 檢查端口佔用
lsof -i :3100
lsof -i :58000

# 如果發現異常進程，終止後重啟服務
```

## 🚀 完整的重置流程

如果問題仍然存在，請執行以下完整重置：

```bash
cd /home/ubuntu/jaaz

# 1. 停止所有服務
pkill -f "jaaz/react.*vite"
pkill -f "python.*main.py"

# 2. 等待2秒
sleep 2

# 3. 重啟後端
cd /home/ubuntu/jaaz && ./restart_backend.sh

# 4. 等待3秒
sleep 3

# 5. 重啟前端
cd /home/ubuntu/jaaz && ./restart_frontend.sh

# 6. 運行診斷測試
cd /home/ubuntu/jaaz && ./test_智能縮放連接.sh
```

## 📋 使用智能縮放的正確步驟

1. **訪問應用**
   ```
   http://localhost:3100/canvas/default
   ```

2. **上傳PSD文件**
   - 點擊上傳按鈕
   - 選擇您的PSD文件
   - 等待上傳完成

3. **打開智能縮放對話框**
   - 在文件列表中找到上傳的PSD
   - 點擊「智能縮放」按鈕

4. **配置縮放選項**
   - **縮放模式**：選擇「縮放單個PSD文件」或「縮放整個畫布」
   - **輸出模式**：
     - **合成模式**：輸出單張合成圖片
     - **分層模式 ✨**：輸出多個獨立可移動的圖層
   - **目標尺寸**：輸入目標寬度和高度（如：800x600）
   - **API密鑰**：如果環境變量未配置，手動輸入Gemini API密鑰

5. **開始縮放**
   - 點擊「開始智能縮放」
   - 等待1-2分鐘（Gemini API處理時間）
   - 縮放完成後，圖片會自動添加到畫布

## 🔧 常見錯誤處理

### 錯誤：Failed to fetch
**原因**：前端無法連接到後端API

**解決方案**：
1. 確認後端運行：`ps aux | grep "python.*main.py"`
2. 測試後端API：`curl http://127.0.0.1:58000/api/config`
3. 重啟服務：`./restart_backend.sh`

### 錯誤：處理超時
**原因**：Gemini API響應時間過長或配額限制

**解決方案**：
1. 等待幾分鐘後重試
2. 減少PSD圖層數量（建議<20層）
3. 檢查Gemini API配額：https://aistudio.google.com/apikey

### 錯誤：RESOURCE_EXHAUSTED
**原因**：Gemini API配額用盡

**解決方案**：
1. 等待配額重置（通常1分鐘）
2. 查看配額使用情況
3. 考慮升級到付費計劃

## 📊 診斷工具

我們提供了一個診斷腳本來快速檢查所有服務狀態：

```bash
cd /home/ubuntu/jaaz
./test_智能縮放連接.sh
```

這個腳本會檢查：
- ✅ 前後端服務運行狀態
- ✅ 端口監聽情況
- ✅ API連接和代理
- ✅ PSD縮放端點可用性
- ✅ Gemini API密鑰配置

## 🎯 快速檢查清單

在使用智能縮放之前，請確認：

- [ ] 前端運行在 3100 端口
- [ ] 後端運行在 58000 端口
- [ ] 訪問 http://localhost:3100 能看到頁面
- [ ] 訪問 http://localhost:3100/api/config 返回JSON數據
- [ ] Gemini API密鑰已配置
- [ ] 瀏覽器已清除緩存或硬刷新
- [ ] 使用最新版本的前端代碼（執行過 ./restart_frontend.sh）

## 📞 獲取幫助

如果問題仍然存在，請提供以下信息：

1. **診斷腳本輸出**：
   ```bash
   ./test_智能縮放連接.sh
   ```

2. **前端日誌**：
   ```bash
   tail -50 /tmp/jaaz_frontend.log
   ```

3. **後端日誌**：
   ```bash
   tail -50 /home/ubuntu/jaaz/server/backend.log
   ```

4. **瀏覽器控制台錯誤**：
   - 按 F12 打開開發者工具
   - 切換到 Console 標籤
   - 複製所有紅色錯誤信息

## ✨ 成功案例

如果一切正常，您應該看到：

```
✅ 前端運行中 (PID: XXXXX)
✅ 前端監聽端口: 3100
✅ 後端運行中 (PID: XXXXX)
✅ 後端監聽端口: 58000
✅ 前端API代理 (3100->58000): 成功 (200)
✅ 所有檢查通過！
```

然後您就可以愉快地使用智能縮放功能了！🎉

---

**最後更新**：2025-10-29
**診斷工具**：test_智能縮放連接.sh




