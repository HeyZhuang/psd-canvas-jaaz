# PSD 畫布整合功能

## 功能概述

在 `http://localhost:3000/canvas/default` 路由下，我們已經實現了完整的 PSD 文件上傳和圖層編輯功能，支持文字圖層的字體編輯和圖像圖層的替換。

## 主要功能

### 1. PSD 文件上傳和圖層編輯
- 在底部工具欄中點擊上傳按鈕（📤 圖標）
- 選擇 `.psd` 文件進行上傳
- 系統會自動解析 PSD 文件的圖層結構
- 打開圖層編輯器進行詳細編輯

### 2. 文字圖層編輯
- **字體選擇**：支持多種常用字體
- **字體大小**：8px - 200px 可調節
- **字體樣式**：粗體、斜體、底線
- **文字對齊**：左對齊、居中、右對齊
- **文字顏色**：顏色選擇器和十六進制輸入
- **行高調整**：0.5 - 3.0 可調節
- **字間距**：-2px - 10px 可調節
- **文字內容**：直接編輯文字內容
- **實時預覽**：編輯時即時預覽效果

### 3. 圖像圖層編輯
- **圖層可見性**：顯示/隱藏圖層
- **透明度調整**：0% - 100% 可調節
- **圖層重排序**：拖拽重新排列圖層順序
- **圖層複製**：複製現有圖層
- **圖層刪除**：刪除不需要的圖層
- **圖片替換**：替換圖層中的圖片內容

### 4. 畫布整合
- 可以將編輯後的圖層添加到 Excalidraw 畫布
- 圖層會作為圖像元素出現在畫布上
- 支持在畫布上進行進一步的編輯和操作
- 保留圖層的原始屬性和編輯歷史

## 技術實現

### 前端組件
- `PSDCanvasUploader.tsx` - PSD 上傳組件
- `PSDLayerEditor.tsx` - 圖層編輯器組件
- `FontEditor.tsx` - 字體編輯組件
- 集成在 `CanvasToolMenu.tsx` 底部工具欄中

### 後端 API
- `/api/psd/upload` - 上傳 PSD 文件
- `/api/psd/export/{file_id}` - 導出合成圖像（用於獲取 PSD 合成圖像）
- `/api/psd/metadata/{file_id}` - 獲取 PSD 元數據
- `/api/psd/layer/{file_id}/{layer_index}` - 獲取圖層圖像
- `/api/psd/update_layer/{file_id}/{layer_index}` - 更新圖層
- `/api/file/{file_id}` - 獲取導出的文件

### 依賴
- `psd-tools` - Python PSD 文件解析庫
- `Pillow` - 圖像處理庫

## 使用流程

1. **上傳 PSD 文件**
   - 點擊底部工具欄的上傳按鈕（📤 圖標）
   - 選擇 PSD 文件
   - 系統自動上傳並解析圖層結構

2. **圖層編輯**
   - 在圖層編輯器中選擇要編輯的圖層
   - 對於文字圖層：使用字體編輯器調整字體屬性
   - 對於圖像圖層：調整透明度、可見性等屬性
   - 可以拖拽重新排序圖層

3. **添加到畫布**
   - 選擇要添加的圖層
   - 點擊「添加到當前畫布」按鈕
   - 圖層會出現在 Excalidraw 畫布上

4. **進一步編輯**
   - 在畫布上可以對圖層進行移動、縮放等操作
   - 可以與其他畫布元素組合使用
   - 支持 Excalidraw 的所有編輯功能

## 注意事項

- 只支持 `.psd` 格式文件
- 大型 PSD 文件可能需要較長處理時間
- 文字圖層會自動識別並提供字體編輯功能
- 圖像圖層支持替換和基本屬性調整
- 建議在處理大型 PSD 文件前先備份原始文件
- 字體編輯會實時保存到服務器

## 錯誤處理

系統會自動處理以下錯誤情況：
- 非 PSD 格式文件
- 文件上傳失敗
- 圖層解析錯誤
- 網絡連接問題
- CORS 跨域問題（已通過中間件解決）

所有錯誤都會通過 toast 通知顯示給用戶。

## 技術說明

### CORS 配置
後端已配置 CORS 中間件，允許來自 `http://localhost:3000` 的跨域請求：
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://127.0.0.1:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### API 代理
前端使用 Vite 代理配置，將 `/api` 請求代理到後端服務器：
```typescript
proxy: {
  '/api': {
    target: 'http://127.0.0.1:57988',
    changeOrigin: true,
  }
}
```

### PSD 合成圖像獲取
使用現有的 export 端點來獲取 PSD 合成圖像：
1. 調用 `/api/psd/export/{file_id}` POST 請求
2. 返回包含導出文件 URL 的 JSON 響應
3. 使用返回的 URL 獲取實際的圖像文件
4. 將圖像添加到 Excalidraw 畫布
