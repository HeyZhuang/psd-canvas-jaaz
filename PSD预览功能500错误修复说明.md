# PSD预览功能500错误修复说明

## 🐛 问题现象

**错误信息：**
```
请求 URL: http://localhost:3100/api/psd/resize/preview-full-psd
请求方法: POST
状态代码: 500 Internal Server Error
```

**后端日志错误：**
```
预览完整PSD失败: 'GeminiPSDResizeService' object has no attribute 'resize_psd'
AttributeError: 'GeminiPSDResizeService' object has no attribute 'resize_psd'
```

---

## 🔍 问题分析

### 根本原因

在 `server/routers/psd_resize_router.py` 的 `preview_full_psd()` 函数中，调用了不存在的方法名和错误的参数：

**错误代码：**
```python
# ❌ 问题代码（第1326行）
service = GeminiPSDResizeService(api_key=api_key)
new_positions = await service.resize_psd(  # ❌ 方法名错误
    psd_path=psd_file_path,                # ❌ 参数错误
    detection_image_path=detection_image_path,
    original_width=psd.width,
    original_height=psd.height,
    target_width=target_width,
    target_height=target_height
)
```

**问题分析：**
1. `GeminiPSDResizeService` 类中没有 `resize_psd()` 方法
2. 实际的方法名是 `resize_psd_layers()`
3. 参数也不匹配：应该传入 `layers_info`，而不是 `psd_path`

**错误流程：**
```
用户点击"预览效果"
    ↓
前端发送 POST /api/psd/resize/preview-full-psd
    ↓
后端调用 service.resize_psd(...)
    ↓
❌ AttributeError: 方法不存在
    ↓
返回 500 Internal Server Error
```

---

## ✅ 解决方案

### 修复内容

**文件：** `server/routers/psd_resize_router.py`

**修复位置：** 第1326-1333行

**修复前：**
```python
# ❌ 错误的方法调用
new_positions = await service.resize_psd(
    psd_path=psd_file_path,
    detection_image_path=detection_image_path,
    original_width=psd.width,
    original_height=psd.height,
    target_width=target_width,
    target_height=target_height
)
```

**修复后：**
```python
# ✅ 正确的方法调用
new_positions = await service.resize_psd_layers(
    layers_info=all_layers_info,  # 传入图层信息列表
    detection_image_path=detection_image_path,
    original_width=psd.width,
    original_height=psd.height,
    target_width=target_width,
    target_height=target_height
)
```

### 关键修改点

1. **方法名修正**：
   - `resize_psd()` → `resize_psd_layers()`

2. **参数修正**：
   - `psd_path=psd_file_path` → `layers_info=all_layers_info`

---

## 📁 涉及的文件

### 1. `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

**函数：** `preview_full_psd()`（第1289行）

**修改内容：**
- 修正方法名
- 修正参数列表

### 2. `/home/ubuntu/jaaz/server/services/gemini_psd_resize_service.py`

**类：** `GeminiPSDResizeService`

**可用方法：**
- `resize_psd_layers()` - 完整的PSD图层缩放
- `resize_selected_layers()` - 选中图层的缩放
- `call_gemini_api()` - 调用Gemini API

**正确的方法签名：**
```python
async def resize_psd_layers(self, 
                          layers_info: List[Dict[str, Any]],
                          detection_image_path: str,
                          original_width: int,
                          original_height: int,
                          target_width: int,
                          target_height: int) -> List[Dict[str, Any]]:
```

---

## 🧪 验证测试

### 测试步骤

**1. 刷新浏览器**
```bash
按 Ctrl+F5 (Windows/Linux)
或 Cmd+Shift+R (Mac)
```

**2. 准备测试**
- 确保已上传PSD文件
- 打开浏览器开发者工具（F12）

**3. 点击预览效果**
- 设置目标尺寸
- 点击"预览效果"按钮

**4. 验证结果**

**✅ 成功的表现：**
```
- HTTP状态码：200 OK
- 返回预览数据
- 显示图层新位置
- 生成预览图
```

**❌ 失败的表现（修复前）：**
```
- HTTP状态码：500 Internal Server Error
- 控制台错误：AttributeError
```

**5. 检查后端日志**
```bash
tail -f /home/ubuntu/jaaz/server/backend.log
```

**预期日志：**
```
预览完整PSD: file_id=im_xxxx
原始尺寸: 1920x1080
目标尺寸: 800x600
图层总数: 25
调用Gemini API进行图层缩放...
✅ 预览生成成功
```

---

## 🔧 故障排查

### 如果仍然出现500错误

**1. 检查后端日志**
```bash
tail -50 /home/ubuntu/jaaz/server/backend.log
```

**2. 检查Gemini API密钥**
```bash
# 确认API密钥已设置
grep GEMINI_API_KEY /home/ubuntu/jaaz/config.env
```

**3. 检查服务类导入**
```python
# 确认导入正确
from services.gemini_psd_resize_service import GeminiPSDResizeService
```

**4. 手动测试API**
```bash
curl -X POST http://127.0.0.1:58000/api/psd/resize/preview-full-psd \
  -F "file_id=im_xxxx" \
  -F "target_width=800" \
  -F "target_height=600"
```

---

## 📊 技术细节

### GeminiPSDResizeService 类结构

```python
class GeminiPSDResizeService:
    def __init__(self, api_key: Optional[str] = None):
        """初始化服务"""
        
    async def call_gemini_api(self, ...):
        """调用Gemini API"""
        
    async def resize_psd_layers(self, 
                              layers_info: List[Dict[str, Any]],
                              detection_image_path: str,
                              original_width: int,
                              original_height: int,
                              target_width: int,
                              target_height: int) -> List[Dict[str, Any]]:
        """完整的PSD图层缩放流程"""
        
    async def resize_selected_layers(self,
                                    selected_layers_info: List[Dict[str, Any]],
                                    all_layers_info: List[Dict[str, Any]],
                                    detection_image_path: str,
                                    original_width: int,
                                    original_height: int,
                                    target_width: int,
                                    target_height: int) -> List[Dict[str, Any]]:
        """选中图层的缩放"""
```

### API调用流程

```
1. 用户点击预览
    ↓
2. 前端发送请求（file_id, target_width, target_height）
    ↓
3. 后端加载PSD文件
    ↓
4. 提取所有图层信息（get_psd_layers_info）
    ↓
5. 生成检测框图像（draw_detection_boxes）
    ↓
6. 调用Gemini API（resize_psd_layers）
    ↓
7. 获取新位置
    ↓
8. 生成预览数据
    ↓
9. 返回给前端
```

---

## 📝 相关文档

- [Gemini_PSD_缩放API文档.md](./Gemini_PSD_缩放API文档.md)
- [PSD智能缩放自动展示功能.md](./PSD智能缩放自动展示功能.md)
- [PSD完整预览功能实现总结.md](./PSD完整预览功能实现总结.md)

---

## ✅ 修复验证清单

- [x] ✅ 修正方法名 `resize_psd` → `resize_psd_layers`
- [x] ✅ 修正参数 `psd_path` → `layers_info`
- [x] ✅ 重启后端服务（进程ID: 675863）
- [ ] ⏳ 刷新浏览器测试
- [ ] ⏳ 点击预览效果验证
- [ ] ⏳ 确认返回200状态码
- [ ] ⏳ 验证预览数据正确

---

## 🎊 总结

**问题：** PSD预览功能返回500错误  
**原因：** 调用了不存在的方法名和错误的参数  
**修复：** 修正方法名为 `resize_psd_layers`，参数为 `layers_info`  
**状态：** ✅ 已修复，后端已重启  

**关键要点：**
- 🔑 `GeminiPSDResizeService` 的方法名是 `resize_psd_layers`
- 🔑 需要传入 `layers_info` 而不是 `psd_path`
- 🔑 方法签名必须与服务类定义完全匹配
- 🔑 AttributeError 通常表示方法名或属性名错误

---

**修复时间**: 2025-10-30  
**修复状态**: ✅ 已完成  
**后端服务**: ✅ 已重启（进程ID: 675863）  
**前端服务**: ⏳ 需要刷新浏览器测试  

**🎉 PSD预览功能500错误已修复！请刷新浏览器并测试预览功能。** 🚀

