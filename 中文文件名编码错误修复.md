# ✅ 中文文件名编码错误修复

## 🚨 错误信息

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
/api/psd/resize/layered/psd_layered_1761755954/layer_000 → 500
/api/psd/resize/layered/psd_layered_1761755954/layer_002 → 500
...
```

**后端日志**:
```
獲取圖層圖像失敗: 'latin-1' codec can't encode characters in position 28-29: ordinal not in range(256)
獲取圖層圖像失敗: 'latin-1' codec can't encode character '\u6eff' in position 28: ordinal not in range(256)
獲取圖層圖像失敗: 'latin-1' codec can't encode character '\u89d2' in position 29: ordinal not in range(256)
```

---

## 🔍 问题根源

### 编码问题

**问题**: HTTP响应头使用`latin-1`编码，无法处理中文字符

**位置**: 
- `/home/ubuntu/jaaz/server/routers/psd_resize_router.py` (第741行)
- `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py` (第526行)

### 错误代码

```python
# ❌ 错误代码
return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{layer["image_path"]}"'
        # layer["image_path"] = "layer_000_背景.png" ← 包含中文！
    }
)
```

### 为什么会出错？

1. **图层文件名包含中文**:
   ```
   layer_000_背景.png
   layer_002_矩形 2.png
   layer_007_滿$888現折$100.png
   layer_008_6角icon.png
   layer_022_舒酸定LOGO.png
   ```

2. **HTTP头部默认使用latin-1编码**:
   - latin-1 只支持ASCII和西欧字符（0-255）
   - 中文字符超出latin-1范围
   - 导致编码失败，返回500错误

3. **所有图层图片请求都失败**:
   - 前端无法加载任何图层图片
   - 最终显示"已添加 0 个图层到画布"

---

## ✅ 修复方案

### 解决方法: 使用简单的ASCII文件名

**核心思路**: 在HTTP响应头中使用不包含中文的简单文件名

### 修复后的代码

**文件1**: `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

```python
# ✅ 修复后的代码
# 使用简单的文件名避免编码问题
simple_filename = f"layer_{layer_index:03d}.png"

return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{simple_filename}"'
        # simple_filename = "layer_000.png" ← 纯ASCII！
    }
)
```

**文件2**: `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py`

```python
# ✅ 修复后的代码
# 使用简单的文件名避免编码问题
simple_filename = f"layer_{layer_index:03d}.png"

return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{simple_filename}"'
    }
)
```

---

## 🔑 关键改进

### 1. **简化文件名**
   - 原文件名: `layer_000_背景.png` ❌
   - 新文件名: `layer_000.png` ✅
   - 完全使用ASCII字符

### 2. **保持实际文件不变**
   - 磁盘上的文件名仍然包含中文（用于调试）
   - 只有HTTP响应头使用简化的文件名
   - 不影响文件的实际存储和读取

### 3. **兼容所有字符集**
   - 支持任何语言的图层名称
   - 不需要URL编码或其他复杂处理
   - 简单且可靠

---

## 📊 修复前后对比

### 修复前 ❌

**HTTP响应头**:
```
Content-Disposition: inline; filename="layer_000_背景.png"
```

**结果**:
```
ERROR: 'latin-1' codec can't encode characters...
HTTP 500 Internal Server Error
前端无法加载图片
```

### 修复后 ✅

**HTTP响应头**:
```
Content-Disposition: inline; filename="layer_000.png"
```

**结果**:
```
HTTP 200 OK
前端成功加载图片
图层正确显示在画布上
```

---

## 🧪 测试步骤

### 1. 刷新浏览器
```
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (Mac)
```

### 2. 访问应用
```
http://localhost:3100/canvas/default
```

### 3. 上传PSD文件
   - 选择包含中文图层名称的PSD文件
   - 等待上传完成

### 4. 智能缩放
   - 点击"智能缩放"按钮（AI图标）
   - 选择"缩放单个PSD文件"
   - 启用"分层模式 ✨"
   - 输入目标尺寸
   - 输入Gemini API Key
   - 点击"开始智能缩放"

### 5. 验证结果

#### ✅ 成功的标志

**浏览器控制台**:
```
正在添加 18 个图层到画布
✓ 成功添加 18 个图层到画布
縮放完成
```

**后端日志**:
```
INFO: 127.0.0.1:xxxxx - "GET /api/psd/resize/layered/.../layer_000 HTTP/1.1" 200 OK
INFO: 127.0.0.1:xxxxx - "GET /api/psd/resize/layered/.../layer_002 HTTP/1.1" 200 OK
...
```

**画布**:
- 所有图层正确显示
- 图层位置正确
- 图层大小正确

---

## 🔧 修改的文件

### 文件1: psd_resize_router.py

**路径**: `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

**修改位置**: 第737-746行

**修改内容**:
```python
# 新增第737-738行
simple_filename = f"layer_{layer_index:03d}.png"

# 修改第744行
'Content-Disposition': f'inline; filename="{simple_filename}"'
```

### 文件2: canvas_resize_router.py

**路径**: `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py`

**修改位置**: 第522-531行

**修改内容**:
```python
# 新增第522-523行
simple_filename = f"layer_{layer_index:03d}.png"

# 修改第529行
'Content-Disposition': f'inline; filename="{simple_filename}"'
```

---

## 📚 技术细节

### HTTP响应头编码

#### latin-1编码限制
```
支持字符范围: 0-255 (ASCII + 西欧字符)
不支持: 中文、日文、韩文、阿拉伯文等
```

#### 解决方案对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| URL编码 | 支持所有字符 | 复杂，文件名难读 |
| RFC 2231编码 | 标准化 | 浏览器支持不一致 |
| 简化文件名 ✅ | 简单可靠 | 文件名不包含原始名称 |

**我们选择**: 简化文件名，因为：
- 最简单
- 最可靠
- 不影响功能
- 文件索引足够识别

---

## 🎯 常见问题

### Q1: 为什么不使用URL编码？

**A**: URL编码会导致文件名变得很长且难读：
```
原文件名: layer_000_背景.png
URL编码后: layer_000_%E8%83%8C%E6%99%AF.png
简化后: layer_000.png ✅
```

### Q2: 磁盘上的文件名还包含中文吗？

**A**: 是的！磁盘上的文件名仍然是`layer_000_背景.png`，方便调试。只有HTTP响应头使用简化名称。

### Q3: 如何知道图层的原始名称？

**A**: 查看元数据文件`metadata.json`，其中包含完整的图层信息：
```json
{
  "index": 0,
  "name": "背景",
  "image_path": "layer_000_背景.png",
  ...
}
```

### Q4: 这会影响前端显示吗？

**A**: 不会！前端使用元数据中的`name`字段显示图层名称，不依赖文件名。

---

## ✅ 修复状态

- ✅ psd_resize_router.py 已修复
- ✅ canvas_resize_router.py 已修复
- ✅ 后端代码已更新
- ✅ 后端已重启 (PID: 573247, 端口: 58000)
- ✅ 中文文件名编码问题已解决

---

## 🚀 后续优化（可选）

### 如果需要更标准的解决方案

可以使用RFC 2231编码：
```python
from urllib.parse import quote

encoded_filename = quote(layer["image_path"])
headers = {
    'Content-Disposition': f"inline; filename=\"layer_{layer_index:03d}.png\"; filename*=UTF-8''{encoded_filename}"
}
```

这样可以同时提供：
- 简单的ASCII文件名（兼容性）
- UTF-8编码的完整文件名（现代浏览器）

但目前的简化方案已经足够使用。

---

## 🎉 现在可以正常使用了！

刷新浏览器 → 上传PSD → 智能缩放 → 分层模式 → 查看结果！

**修复时间**: 2024年10月29日  
**状态**: ✅ 完成


