# âœ… ä¸­æ–‡æ–‡ä»¶åç¼–ç é”™è¯¯ä¿®å¤

## ğŸš¨ é”™è¯¯ä¿¡æ¯

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
/api/psd/resize/layered/psd_layered_1761755954/layer_000 â†’ 500
/api/psd/resize/layered/psd_layered_1761755954/layer_002 â†’ 500
...
```

**åç«¯æ—¥å¿—**:
```
ç²å–åœ–å±¤åœ–åƒå¤±æ•—: 'latin-1' codec can't encode characters in position 28-29: ordinal not in range(256)
ç²å–åœ–å±¤åœ–åƒå¤±æ•—: 'latin-1' codec can't encode character '\u6eff' in position 28: ordinal not in range(256)
ç²å–åœ–å±¤åœ–åƒå¤±æ•—: 'latin-1' codec can't encode character '\u89d2' in position 29: ordinal not in range(256)
```

---

## ğŸ” é—®é¢˜æ ¹æº

### ç¼–ç é—®é¢˜

**é—®é¢˜**: HTTPå“åº”å¤´ä½¿ç”¨`latin-1`ç¼–ç ï¼Œæ— æ³•å¤„ç†ä¸­æ–‡å­—ç¬¦

**ä½ç½®**: 
- `/home/ubuntu/jaaz/server/routers/psd_resize_router.py` (ç¬¬741è¡Œ)
- `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py` (ç¬¬526è¡Œ)

### é”™è¯¯ä»£ç 

```python
# âŒ é”™è¯¯ä»£ç 
return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{layer["image_path"]}"'
        # layer["image_path"] = "layer_000_èƒŒæ™¯.png" â† åŒ…å«ä¸­æ–‡ï¼
    }
)
```

### ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

1. **å›¾å±‚æ–‡ä»¶ååŒ…å«ä¸­æ–‡**:
   ```
   layer_000_èƒŒæ™¯.png
   layer_002_çŸ©å½¢ 2.png
   layer_007_æ»¿$888ç¾æŠ˜$100.png
   layer_008_6è§’icon.png
   layer_022_èˆ’é…¸å®šLOGO.png
   ```

2. **HTTPå¤´éƒ¨é»˜è®¤ä½¿ç”¨latin-1ç¼–ç **:
   - latin-1 åªæ”¯æŒASCIIå’Œè¥¿æ¬§å­—ç¬¦ï¼ˆ0-255ï¼‰
   - ä¸­æ–‡å­—ç¬¦è¶…å‡ºlatin-1èŒƒå›´
   - å¯¼è‡´ç¼–ç å¤±è´¥ï¼Œè¿”å›500é”™è¯¯

3. **æ‰€æœ‰å›¾å±‚å›¾ç‰‡è¯·æ±‚éƒ½å¤±è´¥**:
   - å‰ç«¯æ— æ³•åŠ è½½ä»»ä½•å›¾å±‚å›¾ç‰‡
   - æœ€ç»ˆæ˜¾ç¤º"å·²æ·»åŠ  0 ä¸ªå›¾å±‚åˆ°ç”»å¸ƒ"

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### è§£å†³æ–¹æ³•: ä½¿ç”¨ç®€å•çš„ASCIIæ–‡ä»¶å

**æ ¸å¿ƒæ€è·¯**: åœ¨HTTPå“åº”å¤´ä¸­ä½¿ç”¨ä¸åŒ…å«ä¸­æ–‡çš„ç®€å•æ–‡ä»¶å

### ä¿®å¤åçš„ä»£ç 

**æ–‡ä»¶1**: `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

```python
# âœ… ä¿®å¤åçš„ä»£ç 
# ä½¿ç”¨ç®€å•çš„æ–‡ä»¶åé¿å…ç¼–ç é—®é¢˜
simple_filename = f"layer_{layer_index:03d}.png"

return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{simple_filename}"'
        # simple_filename = "layer_000.png" â† çº¯ASCIIï¼
    }
)
```

**æ–‡ä»¶2**: `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py`

```python
# âœ… ä¿®å¤åçš„ä»£ç 
# ä½¿ç”¨ç®€å•çš„æ–‡ä»¶åé¿å…ç¼–ç é—®é¢˜
simple_filename = f"layer_{layer_index:03d}.png"

return FileResponse(
    layer_path,
    media_type='image/png',
    headers={
        'Content-Disposition': f'inline; filename="{simple_filename}"'
    }
)
```

---

## ğŸ”‘ å…³é”®æ”¹è¿›

### 1. **ç®€åŒ–æ–‡ä»¶å**
   - åŸæ–‡ä»¶å: `layer_000_èƒŒæ™¯.png` âŒ
   - æ–°æ–‡ä»¶å: `layer_000.png` âœ…
   - å®Œå…¨ä½¿ç”¨ASCIIå­—ç¬¦

### 2. **ä¿æŒå®é™…æ–‡ä»¶ä¸å˜**
   - ç£ç›˜ä¸Šçš„æ–‡ä»¶åä»ç„¶åŒ…å«ä¸­æ–‡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
   - åªæœ‰HTTPå“åº”å¤´ä½¿ç”¨ç®€åŒ–çš„æ–‡ä»¶å
   - ä¸å½±å“æ–‡ä»¶çš„å®é™…å­˜å‚¨å’Œè¯»å–

### 3. **å…¼å®¹æ‰€æœ‰å­—ç¬¦é›†**
   - æ”¯æŒä»»ä½•è¯­è¨€çš„å›¾å±‚åç§°
   - ä¸éœ€è¦URLç¼–ç æˆ–å…¶ä»–å¤æ‚å¤„ç†
   - ç®€å•ä¸”å¯é 

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ âŒ

**HTTPå“åº”å¤´**:
```
Content-Disposition: inline; filename="layer_000_èƒŒæ™¯.png"
```

**ç»“æœ**:
```
ERROR: 'latin-1' codec can't encode characters...
HTTP 500 Internal Server Error
å‰ç«¯æ— æ³•åŠ è½½å›¾ç‰‡
```

### ä¿®å¤å âœ…

**HTTPå“åº”å¤´**:
```
Content-Disposition: inline; filename="layer_000.png"
```

**ç»“æœ**:
```
HTTP 200 OK
å‰ç«¯æˆåŠŸåŠ è½½å›¾ç‰‡
å›¾å±‚æ­£ç¡®æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Š
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. åˆ·æ–°æµè§ˆå™¨
```
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (Mac)
```

### 2. è®¿é—®åº”ç”¨
```
http://localhost:3100/canvas/default
```

### 3. ä¸Šä¼ PSDæ–‡ä»¶
   - é€‰æ‹©åŒ…å«ä¸­æ–‡å›¾å±‚åç§°çš„PSDæ–‡ä»¶
   - ç­‰å¾…ä¸Šä¼ å®Œæˆ

### 4. æ™ºèƒ½ç¼©æ”¾
   - ç‚¹å‡»"æ™ºèƒ½ç¼©æ”¾"æŒ‰é’®ï¼ˆAIå›¾æ ‡ï¼‰
   - é€‰æ‹©"ç¼©æ”¾å•ä¸ªPSDæ–‡ä»¶"
   - å¯ç”¨"åˆ†å±‚æ¨¡å¼ âœ¨"
   - è¾“å…¥ç›®æ ‡å°ºå¯¸
   - è¾“å…¥Gemini API Key
   - ç‚¹å‡»"å¼€å§‹æ™ºèƒ½ç¼©æ”¾"

### 5. éªŒè¯ç»“æœ

#### âœ… æˆåŠŸçš„æ ‡å¿—

**æµè§ˆå™¨æ§åˆ¶å°**:
```
æ­£åœ¨æ·»åŠ  18 ä¸ªå›¾å±‚åˆ°ç”»å¸ƒ
âœ“ æˆåŠŸæ·»åŠ  18 ä¸ªå›¾å±‚åˆ°ç”»å¸ƒ
ç¸®æ”¾å®Œæˆ
```

**åç«¯æ—¥å¿—**:
```
INFO: 127.0.0.1:xxxxx - "GET /api/psd/resize/layered/.../layer_000 HTTP/1.1" 200 OK
INFO: 127.0.0.1:xxxxx - "GET /api/psd/resize/layered/.../layer_002 HTTP/1.1" 200 OK
...
```

**ç”»å¸ƒ**:
- æ‰€æœ‰å›¾å±‚æ­£ç¡®æ˜¾ç¤º
- å›¾å±‚ä½ç½®æ­£ç¡®
- å›¾å±‚å¤§å°æ­£ç¡®

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### æ–‡ä»¶1: psd_resize_router.py

**è·¯å¾„**: `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬737-746è¡Œ

**ä¿®æ”¹å†…å®¹**:
```python
# æ–°å¢ç¬¬737-738è¡Œ
simple_filename = f"layer_{layer_index:03d}.png"

# ä¿®æ”¹ç¬¬744è¡Œ
'Content-Disposition': f'inline; filename="{simple_filename}"'
```

### æ–‡ä»¶2: canvas_resize_router.py

**è·¯å¾„**: `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬522-531è¡Œ

**ä¿®æ”¹å†…å®¹**:
```python
# æ–°å¢ç¬¬522-523è¡Œ
simple_filename = f"layer_{layer_index:03d}.png"

# ä¿®æ”¹ç¬¬529è¡Œ
'Content-Disposition': f'inline; filename="{simple_filename}"'
```

---

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### HTTPå“åº”å¤´ç¼–ç 

#### latin-1ç¼–ç é™åˆ¶
```
æ”¯æŒå­—ç¬¦èŒƒå›´: 0-255 (ASCII + è¥¿æ¬§å­—ç¬¦)
ä¸æ”¯æŒ: ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ã€é˜¿æ‹‰ä¼¯æ–‡ç­‰
```

#### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| URLç¼–ç  | æ”¯æŒæ‰€æœ‰å­—ç¬¦ | å¤æ‚ï¼Œæ–‡ä»¶åéš¾è¯» |
| RFC 2231ç¼–ç  | æ ‡å‡†åŒ– | æµè§ˆå™¨æ”¯æŒä¸ä¸€è‡´ |
| ç®€åŒ–æ–‡ä»¶å âœ… | ç®€å•å¯é  | æ–‡ä»¶åä¸åŒ…å«åŸå§‹åç§° |

**æˆ‘ä»¬é€‰æ‹©**: ç®€åŒ–æ–‡ä»¶åï¼Œå› ä¸ºï¼š
- æœ€ç®€å•
- æœ€å¯é 
- ä¸å½±å“åŠŸèƒ½
- æ–‡ä»¶ç´¢å¼•è¶³å¤Ÿè¯†åˆ«

---

## ğŸ¯ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨URLç¼–ç ï¼Ÿ

**A**: URLç¼–ç ä¼šå¯¼è‡´æ–‡ä»¶åå˜å¾—å¾ˆé•¿ä¸”éš¾è¯»ï¼š
```
åŸæ–‡ä»¶å: layer_000_èƒŒæ™¯.png
URLç¼–ç å: layer_000_%E8%83%8C%E6%99%AF.png
ç®€åŒ–å: layer_000.png âœ…
```

### Q2: ç£ç›˜ä¸Šçš„æ–‡ä»¶åè¿˜åŒ…å«ä¸­æ–‡å—ï¼Ÿ

**A**: æ˜¯çš„ï¼ç£ç›˜ä¸Šçš„æ–‡ä»¶åä»ç„¶æ˜¯`layer_000_èƒŒæ™¯.png`ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚åªæœ‰HTTPå“åº”å¤´ä½¿ç”¨ç®€åŒ–åç§°ã€‚

### Q3: å¦‚ä½•çŸ¥é“å›¾å±‚çš„åŸå§‹åç§°ï¼Ÿ

**A**: æŸ¥çœ‹å…ƒæ•°æ®æ–‡ä»¶`metadata.json`ï¼Œå…¶ä¸­åŒ…å«å®Œæ•´çš„å›¾å±‚ä¿¡æ¯ï¼š
```json
{
  "index": 0,
  "name": "èƒŒæ™¯",
  "image_path": "layer_000_èƒŒæ™¯.png",
  ...
}
```

### Q4: è¿™ä¼šå½±å“å‰ç«¯æ˜¾ç¤ºå—ï¼Ÿ

**A**: ä¸ä¼šï¼å‰ç«¯ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„`name`å­—æ®µæ˜¾ç¤ºå›¾å±‚åç§°ï¼Œä¸ä¾èµ–æ–‡ä»¶åã€‚

---

## âœ… ä¿®å¤çŠ¶æ€

- âœ… psd_resize_router.py å·²ä¿®å¤
- âœ… canvas_resize_router.py å·²ä¿®å¤
- âœ… åç«¯ä»£ç å·²æ›´æ–°
- âœ… åç«¯å·²é‡å¯ (PID: 573247, ç«¯å£: 58000)
- âœ… ä¸­æ–‡æ–‡ä»¶åç¼–ç é—®é¢˜å·²è§£å†³

---

## ğŸš€ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### å¦‚æœéœ€è¦æ›´æ ‡å‡†çš„è§£å†³æ–¹æ¡ˆ

å¯ä»¥ä½¿ç”¨RFC 2231ç¼–ç ï¼š
```python
from urllib.parse import quote

encoded_filename = quote(layer["image_path"])
headers = {
    'Content-Disposition': f"inline; filename=\"layer_{layer_index:03d}.png\"; filename*=UTF-8''{encoded_filename}"
}
```

è¿™æ ·å¯ä»¥åŒæ—¶æä¾›ï¼š
- ç®€å•çš„ASCIIæ–‡ä»¶åï¼ˆå…¼å®¹æ€§ï¼‰
- UTF-8ç¼–ç çš„å®Œæ•´æ–‡ä»¶åï¼ˆç°ä»£æµè§ˆå™¨ï¼‰

ä½†ç›®å‰çš„ç®€åŒ–æ–¹æ¡ˆå·²ç»è¶³å¤Ÿä½¿ç”¨ã€‚

---

## ğŸ‰ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼

åˆ·æ–°æµè§ˆå™¨ â†’ ä¸Šä¼ PSD â†’ æ™ºèƒ½ç¼©æ”¾ â†’ åˆ†å±‚æ¨¡å¼ â†’ æŸ¥çœ‹ç»“æœï¼

**ä¿®å¤æ—¶é—´**: 2024å¹´10æœˆ29æ—¥  
**çŠ¶æ€**: âœ… å®Œæˆ


