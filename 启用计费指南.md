# 🚀 启用 Google Cloud 计费 - 完整指南

## ⚠️ 重要发现

您的 API Keys 显示状态：
```
Quota tier: Set up billing - Unavailable
```

这意味着：**必须先启用计费才能使用 Gemini API！**

---

## 💳 为什么需要启用计费？

### Google Cloud 的要求：

1. **验证身份**
   - Google 需要验证您不是机器人
   - 绑定信用卡是验证方式之一

2. **防止滥用**
   - 防止恶意用户大量创建免费账户
   - 确保服务质量

3. **超出配额时的备选方案**
   - 如果免费配额用完，可以选择付费继续使用
   - 或者停止服务

### 重要提示：

✅ **启用计费不等于立即收费！**
- 免费配额内完全免费
- 只有超出免费配额才会收费
- 可以设置预算提醒，防止意外费用

---

## 📋 启用计费的详细步骤

### 方法 1：通过 Google AI Studio（推荐）⭐

#### 步骤 1：访问计费页面

访问：https://aistudio.google.com/

#### 步骤 2：点击 "Set up billing"

在 API Keys 列表中，点击任一 API Key 旁边的 "Set up billing" 链接。

#### 步骤 3：选择或创建计费账户

系统会引导您：
1. 创建新的计费账户
2. 或选择已有的计费账户

#### 步骤 4：填写计费信息

需要提供：
- 国家/地区
- 信用卡信息（Visa、MasterCard、American Express）
- 账单地址

#### 步骤 5：确认并启用

1. 确认信息无误
2. 同意服务条款
3. 点击"启用计费"

---

### 方法 2：通过 Google Cloud Console（详细控制）

#### 步骤 1：访问 Google Cloud Console

访问：https://console.cloud.google.com/

#### 步骤 2：选择 pi3resize 项目

在顶部导航栏，确保选择了 `pi3resize` 项目。

#### 步骤 3：进入计费页面

方式 A：
- 点击左上角菜单 ☰
- 选择 "Billing"（计费）

方式 B：
- 直接访问：https://console.cloud.google.com/billing

#### 步骤 4：链接计费账户

如果看到 "This project has no billing account"（此项目没有计费账户）：

1. 点击 "LINK A BILLING ACCOUNT"（链接计费账户）
2. 选择以下之一：
   - **Create billing account**（创建计费账户）- 如果是首次使用
   - 选择已有的计费账户 - 如果已经创建过

#### 步骤 5：填写计费信息（如果创建新账户）

**基本信息：**
- Account type: Individual（个人）或 Business（企业）
- Name and address: 填写真实信息
- Country: 选择您的国家

**付款信息：**
- Payment method: Credit or debit card（信用卡或借记卡）
- Card number: 卡号
- Expiration date: 过期日期
- CVC: 安全码
- Billing address: 账单地址

#### 步骤 6：接受服务条款

- 阅读并同意 Google Cloud 服务条款
- 点击 "Start my free trial"（开始免费试用）或 "Enable Billing"（启用计费）

#### 步骤 7：验证计费账户

Google 可能会：
1. 从您的信用卡扣除小额验证费用（通常 $1，会立即退还）
2. 发送验证邮件到您的邮箱

完成验证后，计费账户即启用。

---

## 🎁 Google Cloud 免费优惠

### 新用户优惠（New User Credits）

如果您是新用户，通常可以获得：
- **$300 免费额度**
- **有效期 90 天**
- 可用于所有 Google Cloud 服务

### Gemini API 永久免费配额

启用计费后，您仍然享有免费配额：
```
每分钟请求数（RPM）：15 次     - 免费
每天请求数（RPD）：1,500 次    - 免费
每分钟 Token（TPM）：1M tokens - 免费
```

**只有超出这些限制才会收费！**

---

## 💰 费用说明

### 免费配额范围内：完全免费 ✅

如果您的使用量在免费配额内：
```
每天 < 1,500 次请求
每分钟 < 15 次请求
```
→ **完全免费，不会产生任何费用**

### 超出免费配额的定价

如果超出免费配额，付费定价：
- Input: $0.000125 per 1K characters
- Output: $0.000375 per 1K characters

**示例计算：**
```
如果每天处理 3,000 次请求（超出免费 1,500 次）
假设每次请求 1,000 字符输入，2,000 字符输出

额外费用 = 1,500 次 × (1K × $0.000125 + 2K × $0.000375)
         = 1,500 × ($0.000125 + $0.00075)
         = 1,500 × $0.000875
         = $1.31 / 天
```

对于普通使用，费用很低！

---

## 🛡️ 防止意外费用的措施

### 1. 设置预算提醒

**步骤：**
1. 访问：https://console.cloud.google.com/billing/budgets
2. 点击 "CREATE BUDGET"（创建预算）
3. 设置预算金额（例如：$10）
4. 设置提醒阈值（例如：50%、90%、100%）
5. 添加邮箱地址接收提醒

### 2. 设置配额限制

**步骤：**
1. 访问：https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/quotas
2. 选择要限制的配额（例如：RPD）
3. 点击 "EDIT QUOTAS"（编辑配额）
4. 设置自定义限制

### 3. 启用计费导出

将计费数据导出到 BigQuery，实时监控费用：
1. 访问：https://console.cloud.google.com/billing/export
2. 启用 "Billing export"
3. 选择 BigQuery 数据集

### 4. 使用成本监控工具

Google Cloud 提供的工具：
- Cost Table
- Cost Breakdown
- Reports

访问：https://console.cloud.google.com/billing/reports

---

## ✅ 验证计费已启用

### 方法 1：检查 API Keys 状态

1. 访问：https://aistudio.google.com/app/apikey
2. 查看 API Keys 列表
3. "Quota tier" 应该从 "Unavailable" 变为具体的配额信息

### 方法 2：测试 API 调用

运行测试脚本：
```bash
cd /home/ubuntu/ckz/psd-canvas-jaaz
python3 test_gemini_connection.py
```

如果成功，会看到：
```
✅ API 调用成功！
📝 响应内容: ...
```

如果仍然失败：
- 等待 5-10 分钟让设置生效
- 重新生成 API Key

### 方法 3：检查项目计费状态

1. 访问：https://console.cloud.google.com/
2. 选择 `pi3resize` 项目
3. 顶部应该显示计费账户信息
4. 不应该再看到 "This project has no billing account" 提示

---

## 🔧 常见问题

### Q1: 我没有信用卡，可以使用吗？

**A**: 不可以。Google Cloud 要求信用卡或借记卡来验证身份。

**替代方案**：
- 使用虚拟信用卡（某些银行提供）
- 使用 PayPal（某些地区支持）
- 请朋友帮忙（风险自负）

### Q2: 会立即扣费吗？

**A**: 不会！
- Google 可能会扣除 $1 验证费用，但会立即退还
- 只有超出免费配额才会真正收费
- 可以设置预算提醒防止意外费用

### Q3: 如何确保只使用免费配额？

**A**: 设置配额限制：
1. 在 Google Cloud Console 设置 RPD 限制为 1,500
2. 设置预算提醒为 $0.01
3. 监控使用量

### Q4: 启用计费后多久生效？

**A**: 
- 通常 5-10 分钟
- 某些情况下可能需要 1 小时
- 建议启用后等待一会儿再测试

### Q5: 如何取消计费？

**A**: 可以随时取消：
1. 访问：https://console.cloud.google.com/billing
2. 选择计费账户
3. 点击 "Close billing account"（关闭计费账户）

**注意**：关闭后将无法使用需要计费的服务。

### Q6: 我在中国大陆，可以使用吗？

**A**: 
- 可以使用 Gemini API
- 但需要：
  - 国际信用卡（Visa、MasterCard）
  - 或香港/其他地区的信用卡
- 某些功能可能受限

### Q7: 启用计费是否安全？

**A**: 是的，非常安全：
- Google 使用业界标准的加密技术
- 符合 PCI DSS 安全标准
- 可以设置预算上限保护
- 可以随时取消

---

## 📞 需要帮助？

### Google 官方支持

**计费支持页面：**
https://cloud.google.com/billing/docs/how-to/get-support

**Gemini API 文档：**
https://ai.google.dev/gemini-api/docs

**社区论坛：**
https://discuss.ai.google.dev/

### 联系 Google 支持

1. 访问：https://cloud.google.com/support
2. 选择支持级别
3. 提交支持请求

---

## 🎯 下一步操作清单

完成以下步骤以启用您的 Gemini API：

- [ ] 1. 访问 https://console.cloud.google.com/billing
- [ ] 2. 选择 `pi3resize` 项目
- [ ] 3. 创建或链接计费账户
- [ ] 4. 添加信用卡信息
- [ ] 5. 确认并启用计费
- [ ] 6. 等待 5-10 分钟让设置生效
- [ ] 7. 设置预算提醒（推荐：$10）
- [ ] 8. 访问 https://aistudio.google.com/app/apikey 确认配额可用
- [ ] 9. 运行 `python3 test_gemini_connection.py` 测试
- [ ] 10. 开始使用智能缩放功能！

---

## ✅ 成功标志

当计费正确启用后，您会看到：

### 在 Google AI Studio：
```
Quota tier: 
  - 不再显示 "Unavailable"
  - 显示具体的 RPM、RPD、TPM 数值
```

### 在测试脚本：
```
============================================================
🎉 测试通过！Gemini API 工作正常
============================================================
```

### 在您的应用：
- 智能缩放功能正常工作
- 不再收到 429 错误
- 可以正常处理 PSD 文件

---

## 💡 重要提醒

**您的代码完全没有问题！** ✅

问题只是需要启用计费。启用后：
1. 免费配额依然可用（1,500 次/天）
2. 不会产生意外费用（设置预算提醒）
3. 所有功能将正常工作

**启用计费后，您的智能缩放功能将完美运行！** 🎉

---

需要更多帮助？运行：
```bash
python3 检查配额状态.py
python3 verify_api_key.py
```

