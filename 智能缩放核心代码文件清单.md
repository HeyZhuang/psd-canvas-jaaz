# 智能缩放核心代码文件清单

## 📋 概述

本文档列出了 Jaaz 项目中智能缩放功能的所有核心代码文件及其功能说明。

---

## 🎯 前端文件

### 1. PSD缩放对话框
**文件路径**: `/home/ubuntu/jaaz/react/src/components/canvas/PSDResizeDialog.tsx`

**功能**:
- ✅ 智能缩放对话框UI
- ✅ 用户交互界面
- ✅ 处理缩放请求和结果展示
- ✅ 包含画布模式和PSD模式选择
- ✅ 输出格式选择（PNG/PSD）

**核心函数**:
- `handleResize()` - 处理PSD文件缩放
- `handleCanvasResize()` - 处理画布缩放
- `addResizedImageToCanvas()` - 将缩放结果添加到画布

**关键特性**:
- 双模式支持（PSD文件 / 整个画布）
- 双格式输出（PNG / PSD）
- 自动展示到画布
- 进度显示和错误处理

---

### 2. 画布工具菜单
**文件路径**: `/home/ubuntu/jaaz/react/src/components/canvas/menu/CanvasToolMenu.tsx`

**功能**:
- ✅ 智能缩放按钮（约第829行）
- ✅ 打开缩放对话框的入口
- ✅ 智能缩放侧边栏界面
- ✅ PSD上传和管理

**关键代码位置**:
```typescript
// 第829行附近
<span className="text-sm font-medium">智能缩放</span>
```

**交互流程**:
1. 用户点击"智能缩放"按钮
2. 打开 `PSDResizeDialog` 对话框
3. 显示PSD信息和缩放选项

---

### 3. 画布转PSD工具 ✨
**文件路径**: `/home/ubuntu/jaaz/react/src/utils/canvasToPSD.ts`

**功能**:
- ✅ 画布数据收集工具
- ✅ 图层信息提取
- ✅ 数据验证

**核心函数**:
```typescript
// 收集画布图片元素
export function collectCanvasImageData(
  excalidrawAPI: ExcalidrawImperativeAPI
): CanvasData | null

// 验证画布数据
export function validateCanvasData(
  canvasData: CanvasData | null
): boolean

// 计算画布边界
function calculateCanvasBounds(elements: any[])
```

**数据结构**:
```typescript
interface CanvasLayer {
  id: number
  name: string
  x: number
  y: number
  width: number
  height: number
  opacity: number
  fileId: string
  dataURL: string
  zIndex: number | string
}

interface CanvasData {
  width: number
  height: number
  layers: CanvasLayer[]
}
```

---

## 🖥️ 后端文件

### 4. PSD智能缩放路由
**文件路径**: `/home/ubuntu/jaaz/server/routers/psd_resize_router.py`

**功能**:
- ✅ PSD文件智能缩放API
- ✅ `/api/psd/resize` 端点
- ✅ 处理单个PSD文件的缩放

**API端点**:
```python
@router.post("/api/psd/resize")
async def resize_psd(
    file_id: str = Form(...),
    target_width: int = Form(...),
    target_height: int = Form(...),
    api_key: Optional[str] = Form(None)
)
```

**工作流程**:
1. 接收PSD文件ID和目标尺寸
2. 提取图层信息
3. 调用Gemini API生成缩放方案
4. 应用缩放并重建PSD
5. 返回结果URL

---

### 5. 画布智能缩放路由 ✨
**文件路径**: `/home/ubuntu/jaaz/server/routers/canvas_resize_router.py`

**功能**:
- ✅ 画布智能缩放API
- ✅ `/api/canvas/resize` 端点
- ✅ 处理整个画布的智能缩放
- ✅ 支持PNG和PSD格式输出

**API端点**:
```python
@router.post("/api/canvas/resize")
async def resize_canvas(
    canvas_data: str = Form(...),
    target_width: int = Form(...),
    target_height: int = Form(...),
    api_key: Optional[str] = Form(None),
    output_format: str = Form("png")  # "png" 或 "psd"
)
```

**工作流程**:
1. 接收画布数据（JSON格式）
2. 根据output_format选择处理方式
   - PNG模式：合成为单张图片
   - PSD模式：保存为独立图层文件
3. 构造图层信息
4. 生成检测框图像
5. 调用Gemini API分析
6. 应用缩放方案
7. 返回结果

**健康检查**:
```python
@router.get("/api/canvas/health")
async def health_check()
```

---

### 6. Gemini AI智能缩放服务
**文件路径**: `/home/ubuntu/jaaz/server/services/gemini_psd_resize_service.py`

**功能**:
- ✅ Gemini AI智能缩放服务
- ✅ 调用Gemini 2.5 Pro API
- ✅ 生成智能缩放方案

**核心类**:
```python
class GeminiPSDResizeService:
    async def resize_psd_layers(
        self,
        layers_info: List[Dict],
        detection_image_path: str,
        original_width: int,
        original_height: int,
        target_width: int,
        target_height: int
    ) -> List[Dict]:
        # 调用Gemini API分析图层
        # 返回每个图层的新位置
```

**AI分析内容**:
- 图层位置和大小
- 图层重要性
- 布局关系
- 智能缩放方案

---

### 7. 画布转PSD工具 ✨
**文件路径**: `/home/ubuntu/jaaz/server/utils/canvas_to_psd.py`

**功能**:
- ✅ 画布转PSD工具
- ✅ Base64图片处理
- ✅ 图层独立保存
- ✅ 多层PSD创建

**核心函数**:
```python
# Base64图片解码
def decode_base64_image(data_url: str) -> Image.Image

# 保存独立图层文件
def save_canvas_layers_separate(
    canvas_data: Dict[str, Any],
    output_dir: str
) -> Dict[str, Any]

# 合成为单张图片
def save_canvas_layers_as_psd(
    canvas_data: Dict[str, Any],
    output_path: str
) -> str

# 创建多层PSD
def create_layered_psd_from_resized(
    layer_files: List[Dict[str, Any]],
    new_positions: List[Dict[str, Any]],
    target_width: int,
    target_height: int,
    output_path: str
) -> str
```

**技术特点**:
- 处理Base64编码的图片
- 支持图层透明度
- 按zIndex排序保持顺序
- RGBA格式保留透明

---

### 8. PSD缩放和重建工具
**文件路径**: `/home/ubuntu/jaaz/server/utils/resize_psd.py`

**功能**:
- ✅ PSD缩放和重建工具
- ✅ 应用缩放方案
- ✅ 图层重新定位

**核心函数**:
```python
def resize_psd_with_new_positions(
    psd_file_path: str,
    new_pos_json_path: str,
    output_path: str,
    target_width: int,
    target_height: int
) -> Image.Image
```

**处理流程**:
1. 读取PSD文件
2. 读取新位置信息（JSON）
3. 创建新画布
4. 遍历每个图层
5. 调整大小和位置
6. 合成到新画布
7. 保存结果

---

### 9. PSD图层信息提取
**文件路径**: `/home/ubuntu/jaaz/server/utils/psd_layer_info.py`

**功能**:
- ✅ PSD图层信息提取
- ✅ 检测框绘制
- ✅ 图层可视化

**核心函数**:
```python
# 获取图层信息
def get_psd_layers_info(psd_path: str) -> List[Dict]

# 绘制检测框
def draw_detection_boxes(
    psd_path: str,
    layers_info: List[Dict],
    output_path: str
) -> str
```

**提取信息**:
- 图层名称、位置、大小
- 图层类型（layer/group/text）
- 可见性、透明度
- 混合模式

---

## ⚙️ 配置文件

### 10. 主应用入口
**文件路径**: `/home/ubuntu/jaaz/server/main.py`

**功能**:
- ✅ FastAPI应用入口
- ✅ 路由注册
- ✅ 中间件配置

**关键代码**:
```python
# 第10行：导入路由
from routers import (
    config_router, 
    image_router, 
    root_router, 
    workspace, 
    canvas, 
    ssl_test, 
    chat_router, 
    settings, 
    tool_confirmation, 
    psd_router, 
    font_router, 
    psd_resize_router,
    canvas_resize_router  # ✨ 新增
)

# 第68行：注册画布缩放路由
app.include_router(canvas_resize_router.router)
```

**端口配置**:
- 默认端口：`58000`
- 通过 `DEFAULT_PORT` 环境变量配置

---

## 📍 关键代码位置速查

### 智能缩放按钮
```
文件：react/src/components/canvas/menu/CanvasToolMenu.tsx
行号：~829行
代码：<span className="text-sm font-medium">智能缩放</span>
```

### 画布缩放API
```
文件：server/routers/canvas_resize_router.py
端点：POST /api/canvas/resize
参数：canvas_data, target_width, target_height, output_format
```

### PSD缩放API
```
文件：server/routers/psd_resize_router.py
端点：POST /api/psd/resize
参数：file_id, target_width, target_height
```

### Gemini AI服务
```
文件：server/services/gemini_psd_resize_service.py
类：GeminiPSDResizeService
方法：resize_psd_layers()
```

---

## 🔄 数据流程图

```
┌─────────────────────┐
│  用户操作           │
│  点击"智能缩放"     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────┐
│  CanvasToolMenu.tsx         │
│  打开PSDResizeDialog        │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  PSDResizeDialog.tsx        │
│  ├─ 选择模式（PSD/画布）    │
│  ├─ 选择格式（PNG/PSD）     │
│  ├─ 设置目标尺寸            │
│  └─ 开始缩放                │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  canvasToPSD.ts             │
│  收集画布数据               │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  canvas_resize_router.py    │
│  POST /api/canvas/resize    │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  canvas_to_psd.py           │
│  处理图层数据               │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  gemini_psd_resize_service  │
│  AI智能分析                 │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  resize_psd.py              │
│  应用缩放方案               │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  返回结果                   │
│  自动展示到画布             │
└─────────────────────────────┘
```

---

## 🧩 模块依赖关系

```
前端层
├── CanvasToolMenu.tsx
│   └── 调用 → PSDResizeDialog.tsx
│       └── 使用 → canvasToPSD.ts
│           └── 调用 API → /api/canvas/resize

后端层
├── canvas_resize_router.py
│   ├── 使用 → canvas_to_psd.py
│   ├── 调用 → gemini_psd_resize_service.py
│   └── 使用 → resize_psd.py
│
├── psd_resize_router.py
│   ├── 使用 → psd_layer_info.py
│   ├── 调用 → gemini_psd_resize_service.py
│   └── 使用 → resize_psd.py
│
└── main.py
    ├── 注册 → canvas_resize_router
    └── 注册 → psd_resize_router
```

---

## 📊 文件统计

| 类型 | 数量 | 说明 |
|------|------|------|
| 前端文件 | 3 | React组件 + 工具函数 |
| 后端路由 | 2 | API端点定义 |
| 后端服务 | 1 | AI服务 |
| 后端工具 | 3 | 图层处理工具 |
| 配置文件 | 1 | 应用入口 |
| **总计** | **10** | **核心文件** |

---

## 🎯 功能特性

### ✅ 已实现功能

1. **双模式缩放**
   - 单个PSD文件缩放
   - 整个画布缩放 ✨

2. **双格式输出**
   - PNG格式（合成）
   - PSD格式（分层）✨

3. **AI智能分析**
   - Gemini 2.5 Pro
   - 自动计算最佳布局

4. **自动展示**
   - 缩放完成后自动显示到画布
   - 一键添加功能

5. **完善的错误处理**
   - 超时控制（180秒）
   - 网络错误检测
   - 详细错误提示

---

## 📚 相关文档

- **画布智能缩放功能实现总结.md** - 技术实现详解
- **画布智能缩放快速指南.md** - 用户使用指南
- **PSD智能缩放自动展示功能.md** - 自动展示功能说明
- **Jaaz图层存储格式说明.md** - 图层数据格式
- **项目代码分析报告.md** - 完整项目分析

---

## 🔧 开发和调试

### 前端调试
```bash
# 启动前端开发服务器
cd react
npm run dev  # http://localhost:3100
```

### 后端调试
```bash
# 启动后端服务器
cd server
python main.py  # http://127.0.0.1:58000
```

### API测试
```bash
# 健康检查
curl http://127.0.0.1:58000/api/canvas/health

# 测试缩放API
curl -X POST http://127.0.0.1:58000/api/canvas/resize \
  -F "canvas_data={...}" \
  -F "target_width=1920" \
  -F "target_height=1080" \
  -F "output_format=png"
```

---

## 💡 最佳实践

1. **使用前检查**
   - 确保Gemini API密钥已配置
   - 检查画布上是否有图片元素
   - 确认目标尺寸合理（100-4000px）

2. **性能优化**
   - 图层数量控制在20个以内
   - 避免超大尺寸图片
   - 使用PNG格式可提高速度

3. **错误处理**
   - 查看浏览器控制台日志
   - 检查后端服务器日志
   - 参考故障排除文档

---

## 🎓 总结

智能缩放功能是 Jaaz 项目的核心特性之一，通过前后端协作和 AI 技术实现了：

✅ **智能布局**：Gemini AI 自动分析并优化图层位置  
✅ **灵活输出**：支持 PNG 和 PSD 两种格式  
✅ **完整工作流**：从数据收集到结果展示全流程自动化  
✅ **用户友好**：简单的界面，强大的功能  

代码结构清晰，模块化设计，易于维护和扩展。

---

**文档版本**: v1.0  
**更新时间**: 2025-10-29  
**适用版本**: Jaaz v1.0.30+  
**维护者**: AI Assistant





