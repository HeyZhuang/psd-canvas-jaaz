<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas é¡µé¢è°ƒè¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .section {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #007acc;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #1177bb;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .warning {
            color: #ce9178;
        }

        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸ” Canvas é¡µé¢è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h2>å¿«é€Ÿæ“ä½œ</h2>
        <button onclick="location.href='/canvas/default'">æ‰“å¼€ Canvas</button>
        <button onclick="clearAndReload()">æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½</button>
        <button onclick="runAllChecks()">è¿è¡Œæ‰€æœ‰æ£€æŸ¥</button>
    </div>

    <div class="section">
        <h2>æ£€æŸ¥ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <div class="section">
        <h2>DOM ç»“æ„</h2>
        <div id="dom-structure"></div>
    </div>

    <script>
        function clearAndReload() {
            localStorage.clear();
            sessionStorage.clear();
            console.log('ç¼“å­˜å·²æ¸…é™¤');
            alert('ç¼“å­˜å·²æ¸…é™¤ï¼Œå³å°†é‡æ–°åŠ è½½...');
            location.reload(true);
        }

        async function runAllChecks() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥...</p>';

            let html = '';

            // æ£€æŸ¥1: å‰ç«¯æœåŠ¡
            html += '<h3>1. å‰ç«¯æœåŠ¡æ£€æŸ¥</h3>';
            try {
                const res = await fetch('/');
                if (res.ok) {
                    html += `<p class="success">âœ… å‰ç«¯æœåŠ¡æ­£å¸¸ (çŠ¶æ€: ${res.status})</p>`;
                } else {
                    html += `<p class="error">âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸ (çŠ¶æ€: ${res.status})</p>`;
                }
            } catch (e) {
                html += `<p class="error">âŒ å‰ç«¯æœåŠ¡è¿æ¥å¤±è´¥: ${e.message}</p>`;
            }

            // æ£€æŸ¥2: åç«¯API
            html += '<h3>2. åç«¯APIæ£€æŸ¥</h3>';
            try {
                const res = await fetch('/api/config');
                if (res.ok) {
                    html += `<p class="success">âœ… åç«¯APIæ­£å¸¸ (çŠ¶æ€: ${res.status})</p>`;
                } else {
                    html += `<p class="error">âŒ åç«¯APIå¼‚å¸¸ (çŠ¶æ€: ${res.status})</p>`;
                }
            } catch (e) {
                html += `<p class="error">âŒ åç«¯APIè¿æ¥å¤±è´¥: ${e.message}</p>`;
            }

            // æ£€æŸ¥3: Canvas API
            html += '<h3>3. Canvas APIæ£€æŸ¥</h3>';
            try {
                const res = await fetch('/api/canvas/default');
                if (res.ok) {
                    const data = await res.json();
                    html += `<p class="success">âœ… Canvas APIæ­£å¸¸</p>`;
                    html += `<p>ç”»å¸ƒåç§°: ${data.name || 'æœªçŸ¥'}</p>`;
                    html += `<p>ä¼šè¯æ•°: ${data.sessions?.length || 0}</p>`;
                } else {
                    html += `<p class="error">âŒ Canvas APIå¼‚å¸¸ (çŠ¶æ€: ${res.status})</p>`;
                }
            } catch (e) {
                html += `<p class="error">âŒ Canvas APIè¯·æ±‚å¤±è´¥: ${e.message}</p>`;
            }

            // æ£€æŸ¥4: localStorage
            html += '<h3>4. LocalStorageæ£€æŸ¥</h3>';
            const token = localStorage.getItem('jaaz_access_token');
            const user = localStorage.getItem('jaaz_user_info');
            html += `<p>Token: ${token ? '<span class="warning">å­˜åœ¨ï¼ˆå¯èƒ½å¯¼è‡´é—®é¢˜ï¼‰</span>' : '<span class="success">ä¸å­˜åœ¨</span>'}</p>`;
            html += `<p>User Info: ${user ? '<span class="warning">å­˜åœ¨</span>' : '<span class="success">ä¸å­˜åœ¨</span>'}</p>`;
            if (token || user) {
                html += '<p class="warning">âš ï¸ å»ºè®®æ¸…é™¤localStorageåé‡è¯•</p>';
                html += '<button onclick="clearAndReload()">ç«‹å³æ¸…é™¤</button>';
            }

            // æ£€æŸ¥5: æ ·å¼åŠ è½½
            html += '<h3>5. æ ·å¼åŠ è½½æ£€æŸ¥</h3>';
            html += `<p>æ ·å¼è¡¨æ•°é‡: ${document.styleSheets.length}</p>`;
            if (document.styleSheets.length === 0) {
                html += '<p class="error">âŒ æ²¡æœ‰åŠ è½½ä»»ä½•æ ·å¼è¡¨ï¼</p>';
            } else {
                html += '<p class="success">âœ… æ ·å¼è¡¨å·²åŠ è½½</p>';
            }

            results.innerHTML = html;

            // æ£€æŸ¥DOM
            checkDOM();
        }

        function checkDOM() {
            const domDiv = document.getElementById('dom-structure');
            const root = document.getElementById('root');

            if (!root) {
                domDiv.innerHTML = '<p class="error">âŒ æ‰¾ä¸åˆ° #root å…ƒç´ ï¼</p>';
                return;
            }

            let html = '<h3>DOM æ ‘</h3>';
            html += `<p>Root å­å…ƒç´ æ•°: ${root.children.length}</p>`;
            html += `<p>Root innerHTML é•¿åº¦: ${root.innerHTML.length}</p>`;

            if (root.children.length === 0) {
                html += '<p class="error">âŒ #root æ˜¯ç©ºçš„ï¼Reactåº”ç”¨å¯èƒ½æœªæ¸²æŸ“</p>';
                html += '<p class="warning">å¯èƒ½åŸå› ï¼š</p>';
                html += '<ul>';
                html += '<li>JavaScripté”™è¯¯é˜»æ­¢äº†æ¸²æŸ“</li>';
                html += '<li>Provideråˆå§‹åŒ–å¤±è´¥</li>';
                html += '<li>main.tsxåŠ è½½å¤±è´¥</li>';
                html += '</ul>';
            } else {
                html += '<p class="success">âœ… #root æœ‰å†…å®¹</p>';

                // æ£€æŸ¥æ ·å¼
                const style = window.getComputedStyle(root);
                html += `<p>Display: ${style.display}</p>`;
                html += `<p>Opacity: ${style.opacity}</p>`;
                html += `<p>Visibility: ${style.visibility}</p>`;

                if (style.display === 'none') {
                    html += '<p class="error">âŒ Rootè¢«éšè—äº†ï¼(display: none)</p>';
                } else if (style.opacity === '0') {
                    html += '<p class="error">âŒ Rooté€æ˜åº¦ä¸º0ï¼</p>';
                } else if (style.visibility === 'hidden') {
                    html += '<p class="error">âŒ Rootä¸å¯è§ï¼(visibility: hidden)</p>';
                }

                // æ˜¾ç¤ºå‰3å±‚DOMç»“æ„
                html += '<pre>';
                html += getDOMTree(root, 0, 3);
                html += '</pre>';
            }

            domDiv.innerHTML = html;
        }

        function getDOMTree(element, depth, maxDepth) {
            if (depth > maxDepth) return '';

            const indent = '  '.repeat(depth);
            let result = indent + `<${element.tagName.toLowerCase()}`;

            if (element.id) result += ` id="${element.id}"`;
            if (element.className) result += ` class="${element.className.substring(0, 50)}${element.className.length > 50 ? '...' : ''}"`;

            result += `>\n`;

            if (element.children.length > 0) {
                for (let i = 0; i < Math.min(element.children.length, 5); i++) {
                    result += getDOMTree(element.children[i], depth + 1, maxDepth);
                }
                if (element.children.length > 5) {
                    result += indent + `  ... (${element.children.length - 5} more)\n`;
                }
            }

            return result;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(runAllChecks, 500);
        });
    </script>
</body>

</html>



