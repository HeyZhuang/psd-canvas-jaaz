# 前端无法启动问题修复总结

## 🐛 问题描述

访问 `http://localhost:3100/canvas/default` 时，页面一直显示加载动画（转圈），无法正常加载。

## 🔍 问题根源

发现了**两个关键问题**导致页面无法启动：

### 1. Auth API 阻塞问题

**问题代码**: `/home/ubuntu/jaaz/react/src/api/auth.ts`

```typescript
// ❌ 问题：在开发模式下也尝试调用 cloud API
export async function getAuthStatus(): Promise<AuthStatus> {
  if (token && userInfo) {
    const newToken = await refreshToken(token)  // 调用不存在的 API
    // ...
  }
}

// refreshToken 调用的是:
// ${BASE_API_URL}/api/device/refresh-token
// 在开发模式下 BASE_API_URL = ''，所以实际调用 /api/device/refresh-token
// 但后端没有这个路由！返回 404
```

**影响**:
- `AuthProvider` 在应用初始化时调用 `getAuthStatus()`
- 如果 localStorage 中有 token，会尝试调用不存在的 API
- API 返回 404，但代码可能在等待或重试，导致页面阻塞

**根本原因**:
- 后端**没有** `/api/device/*` 相关路由（这些是 Jaaz Cloud 的API）
- 前端在开发模式下不应该调用这些 cloud API
- `BASE_API_URL` 在开发模式下是空字符串 `''`（配置正确）
- 但 `getAuthStatus()` 没有检查环境，直接调用了 cloud API

### 2. ConfigsProvider 重试策略问题

**问题代码**: `/home/ubuntu/jaaz/react/src/contexts/configs.tsx`

```typescript
// ❌ 问题：没有设置重试次数限制
const { data: modelList, refetch: refreshModels } = useQuery({
  queryKey: ['list_models_2'],
  queryFn: () => listModels(),
  staleTime: 1000,  // 只有1秒，导致频繁重新获取
  // 没有 retry 配置，默认会重试3次
})
```

**影响**:
- `/api/list_models` 和 `/api/list_tools` 返回空数组 `[]`
- 但这是正常的（本地模式没有配置模型）
- 没有 retry 限制可能导致不必要的重试
- `staleTime: 1000` 太短，导致频繁刷新

## ✅ 修复方案

### 修复 1: Auth API - 开发模式跳过 cloud API

**文件**: `/home/ubuntu/jaaz/react/src/api/auth.ts`

```typescript
export async function getAuthStatus(): Promise<AuthStatus> {
  // Get auth status from local storage
  const token = localStorage.getItem('jaaz_access_token')
  const userInfo = localStorage.getItem('jaaz_user_info')

  if (token && userInfo) {
    try {
      // ✅ 只在 cloud 模式下才调用 refresh API
      if (BASE_API_URL && BASE_API_URL !== '') {
        const newToken = await refreshToken(token)
        localStorage.setItem('jaaz_access_token', newToken)
        console.log('Token refreshed successfully')
      } else {
        console.log('Development mode: skipping token refresh')
      }

      const authStatus = {
        status: 'logged_in' as const,
        is_logged_in: true,
        user_info: JSON.parse(userInfo),
      }
      return authStatus
    } catch (error) {
      // ... 错误处理
    }
  }

  return { status: 'logged_out' as const, is_logged_in: false }
}
```

**关键改进**:
- ✅ 添加 `if (BASE_API_URL && BASE_API_URL !== '')` 检查
- ✅ 在开发模式下（`BASE_API_URL === ''`）跳过 token refresh
- ✅ 避免调用不存在的 `/api/device/refresh-token` 端点

### 修复 2: ConfigsProvider - 优化重试策略

**文件**: `/home/ubuntu/jaaz/react/src/contexts/configs.tsx`

```typescript
const { data: modelList, refetch: refreshModels } = useQuery({
  queryKey: ['list_models_2'],
  queryFn: () => listModels(),
  staleTime: 5 * 60 * 1000,  // ✅ 改为 5 分钟
  placeholderData: (previousData) => previousData,
  refetchOnWindowFocus: true,
  refetchOnReconnect: true,
  refetchOnMount: true,
  retry: 1,  // ✅ 新增：只重试 1 次，避免阻塞
})
```

**关键改进**:
- ✅ `staleTime` 从 1000ms 改为 5 分钟
- ✅ 添加 `retry: 1` 限制重试次数
- ✅ 避免 API 失败时无限重试导致阻塞

### 修复 3: 启动脚本端口显示错误

**文件**: `/home/ubuntu/jaaz/restart_frontend.sh`

```bash
# ❌ 修复前：显示错误的端口
echo "   端口: 3004"
echo "访问: http://localhost:3004/canvas/default"

# ✅ 修复后：显示正确的端口
echo "   端口: 3100"
echo "访问: http://localhost:3100/canvas/default"
```

**问题**:
- vite.config.ts 中配置的是 3100 端口
- 但脚本硬编码显示 3004，导致用户访问错误的地址

## 🚀 验证修复

### 1. 前端启动验证

```bash
$ cd /home/ubuntu/jaaz
$ bash restart_frontend.sh

✅ 前端启动成功！
   进程ID: 521657
   端口: 3100
   日志: tail -f /tmp/jaaz_frontend.log

访问: http://localhost:3100/canvas/default
```

### 2. 服务状态检查

```bash
# 前端
$ netstat -tlnp | grep 3100
LISTEN  127.0.0.1:3100  users:(("node",pid=521657))

# 后端
$ netstat -tlnp | grep 58000
LISTEN  127.0.0.1:58000  users:(("python",pid=516893))
```

### 3. 访问测试

在浏览器中访问：
```
http://localhost:3100/canvas/default
```

应该能够看到：
- ✅ 画布界面正常加载
- ✅ 不再显示转圈动画
- ✅ 没有 404 错误
- ✅ 控制台显示 "Development mode: skipping token refresh"

## 📋 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `react/src/api/auth.ts` | 🔧 修复 | 开发模式下跳过 cloud API 调用 |
| `react/src/contexts/configs.tsx` | ⚡ 优化 | 添加 retry 限制，优化 staleTime |
| `restart_frontend.sh` | 📝 修正 | 修正端口显示从 3004 改为 3100 |

## 🎯 关键要点

1. **环境区分很重要**
   - 开发模式（`BASE_API_URL === ''`）不应调用 cloud API
   - 生产模式（`BASE_API_URL === 'https://jaaz.app'`）才调用 cloud API

2. **避免阻塞初始化**
   - Provider 的初始化逻辑不应该阻塞应用启动
   - API 调用应该有超时和重试限制
   - 使用 `try-catch` 优雅处理失败

3. **后端 API 路由**
   - 本地后端只有基础功能路由
   - Cloud API（device auth, billing等）只在 jaaz.app 存在
   - 前端需要根据环境判断调用哪些 API

## 🔍 调试工具

如果以后再遇到类似问题，可以使用：

### 1. 诊断页面
```
http://localhost:3100/diagnose_frontend.html
```

### 2. 浏览器控制台
```javascript
// 检查环境变量
console.log('BASE_API_URL:', import.meta.env.VITE_JAAZ_BASE_API_URL)
console.log('DEV mode:', import.meta.env.DEV)

// 检查 localStorage
console.log('Token:', localStorage.getItem('jaaz_access_token'))
console.log('User:', localStorage.getItem('jaaz_user_info'))

// 测试 API
fetch('/api/config').then(r => r.json()).then(console.log)
```

### 3. 查看日志
```bash
# 前端日志
tail -f /tmp/jaaz_frontend.log

# 后端日志
tail -f /home/ubuntu/jaaz/server/backend.log
```

## ✅ 问题已解决

现在可以正常访问：
```
http://localhost:3100/canvas/default
```

页面应该正常加载，不再出现无限转圈的问题！🎉





