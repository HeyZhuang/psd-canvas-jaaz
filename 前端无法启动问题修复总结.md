# å‰ç«¯æ— æ³•å¯åŠ¨é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

è®¿é—® `http://localhost:3100/canvas/default` æ—¶ï¼Œé¡µé¢ä¸€ç›´æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆè½¬åœˆï¼‰ï¼Œæ— æ³•æ­£å¸¸åŠ è½½ã€‚

## ğŸ” é—®é¢˜æ ¹æº

å‘ç°äº†**ä¸¤ä¸ªå…³é”®é—®é¢˜**å¯¼è‡´é¡µé¢æ— æ³•å¯åŠ¨ï¼š

### 1. Auth API é˜»å¡é—®é¢˜

**é—®é¢˜ä»£ç **: `/home/ubuntu/jaaz/react/src/api/auth.ts`

```typescript
// âŒ é—®é¢˜ï¼šåœ¨å¼€å‘æ¨¡å¼ä¸‹ä¹Ÿå°è¯•è°ƒç”¨ cloud API
export async function getAuthStatus(): Promise<AuthStatus> {
  if (token && userInfo) {
    const newToken = await refreshToken(token)  // è°ƒç”¨ä¸å­˜åœ¨çš„ API
    // ...
  }
}

// refreshToken è°ƒç”¨çš„æ˜¯:
// ${BASE_API_URL}/api/device/refresh-token
// åœ¨å¼€å‘æ¨¡å¼ä¸‹ BASE_API_URL = ''ï¼Œæ‰€ä»¥å®é™…è°ƒç”¨ /api/device/refresh-token
// ä½†åç«¯æ²¡æœ‰è¿™ä¸ªè·¯ç”±ï¼è¿”å› 404
```

**å½±å“**:
- `AuthProvider` åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶è°ƒç”¨ `getAuthStatus()`
- å¦‚æœ localStorage ä¸­æœ‰ tokenï¼Œä¼šå°è¯•è°ƒç”¨ä¸å­˜åœ¨çš„ API
- API è¿”å› 404ï¼Œä½†ä»£ç å¯èƒ½åœ¨ç­‰å¾…æˆ–é‡è¯•ï¼Œå¯¼è‡´é¡µé¢é˜»å¡

**æ ¹æœ¬åŸå› **:
- åç«¯**æ²¡æœ‰** `/api/device/*` ç›¸å…³è·¯ç”±ï¼ˆè¿™äº›æ˜¯ Jaaz Cloud çš„APIï¼‰
- å‰ç«¯åœ¨å¼€å‘æ¨¡å¼ä¸‹ä¸åº”è¯¥è°ƒç”¨è¿™äº› cloud API
- `BASE_API_URL` åœ¨å¼€å‘æ¨¡å¼ä¸‹æ˜¯ç©ºå­—ç¬¦ä¸² `''`ï¼ˆé…ç½®æ­£ç¡®ï¼‰
- ä½† `getAuthStatus()` æ²¡æœ‰æ£€æŸ¥ç¯å¢ƒï¼Œç›´æ¥è°ƒç”¨äº† cloud API

### 2. ConfigsProvider é‡è¯•ç­–ç•¥é—®é¢˜

**é—®é¢˜ä»£ç **: `/home/ubuntu/jaaz/react/src/contexts/configs.tsx`

```typescript
// âŒ é—®é¢˜ï¼šæ²¡æœ‰è®¾ç½®é‡è¯•æ¬¡æ•°é™åˆ¶
const { data: modelList, refetch: refreshModels } = useQuery({
  queryKey: ['list_models_2'],
  queryFn: () => listModels(),
  staleTime: 1000,  // åªæœ‰1ç§’ï¼Œå¯¼è‡´é¢‘ç¹é‡æ–°è·å–
  // æ²¡æœ‰ retry é…ç½®ï¼Œé»˜è®¤ä¼šé‡è¯•3æ¬¡
})
```

**å½±å“**:
- `/api/list_models` å’Œ `/api/list_tools` è¿”å›ç©ºæ•°ç»„ `[]`
- ä½†è¿™æ˜¯æ­£å¸¸çš„ï¼ˆæœ¬åœ°æ¨¡å¼æ²¡æœ‰é…ç½®æ¨¡å‹ï¼‰
- æ²¡æœ‰ retry é™åˆ¶å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡è¯•
- `staleTime: 1000` å¤ªçŸ­ï¼Œå¯¼è‡´é¢‘ç¹åˆ·æ–°

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: Auth API - å¼€å‘æ¨¡å¼è·³è¿‡ cloud API

**æ–‡ä»¶**: `/home/ubuntu/jaaz/react/src/api/auth.ts`

```typescript
export async function getAuthStatus(): Promise<AuthStatus> {
  // Get auth status from local storage
  const token = localStorage.getItem('jaaz_access_token')
  const userInfo = localStorage.getItem('jaaz_user_info')

  if (token && userInfo) {
    try {
      // âœ… åªåœ¨ cloud æ¨¡å¼ä¸‹æ‰è°ƒç”¨ refresh API
      if (BASE_API_URL && BASE_API_URL !== '') {
        const newToken = await refreshToken(token)
        localStorage.setItem('jaaz_access_token', newToken)
        console.log('Token refreshed successfully')
      } else {
        console.log('Development mode: skipping token refresh')
      }

      const authStatus = {
        status: 'logged_in' as const,
        is_logged_in: true,
        user_info: JSON.parse(userInfo),
      }
      return authStatus
    } catch (error) {
      // ... é”™è¯¯å¤„ç†
    }
  }

  return { status: 'logged_out' as const, is_logged_in: false }
}
```

**å…³é”®æ”¹è¿›**:
- âœ… æ·»åŠ  `if (BASE_API_URL && BASE_API_URL !== '')` æ£€æŸ¥
- âœ… åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ˆ`BASE_API_URL === ''`ï¼‰è·³è¿‡ token refresh
- âœ… é¿å…è°ƒç”¨ä¸å­˜åœ¨çš„ `/api/device/refresh-token` ç«¯ç‚¹

### ä¿®å¤ 2: ConfigsProvider - ä¼˜åŒ–é‡è¯•ç­–ç•¥

**æ–‡ä»¶**: `/home/ubuntu/jaaz/react/src/contexts/configs.tsx`

```typescript
const { data: modelList, refetch: refreshModels } = useQuery({
  queryKey: ['list_models_2'],
  queryFn: () => listModels(),
  staleTime: 5 * 60 * 1000,  // âœ… æ”¹ä¸º 5 åˆ†é’Ÿ
  placeholderData: (previousData) => previousData,
  refetchOnWindowFocus: true,
  refetchOnReconnect: true,
  refetchOnMount: true,
  retry: 1,  // âœ… æ–°å¢ï¼šåªé‡è¯• 1 æ¬¡ï¼Œé¿å…é˜»å¡
})
```

**å…³é”®æ”¹è¿›**:
- âœ… `staleTime` ä» 1000ms æ”¹ä¸º 5 åˆ†é’Ÿ
- âœ… æ·»åŠ  `retry: 1` é™åˆ¶é‡è¯•æ¬¡æ•°
- âœ… é¿å… API å¤±è´¥æ—¶æ— é™é‡è¯•å¯¼è‡´é˜»å¡

### ä¿®å¤ 3: å¯åŠ¨è„šæœ¬ç«¯å£æ˜¾ç¤ºé”™è¯¯

**æ–‡ä»¶**: `/home/ubuntu/jaaz/restart_frontend.sh`

```bash
# âŒ ä¿®å¤å‰ï¼šæ˜¾ç¤ºé”™è¯¯çš„ç«¯å£
echo "   ç«¯å£: 3004"
echo "è®¿é—®: http://localhost:3004/canvas/default"

# âœ… ä¿®å¤åï¼šæ˜¾ç¤ºæ­£ç¡®çš„ç«¯å£
echo "   ç«¯å£: 3100"
echo "è®¿é—®: http://localhost:3100/canvas/default"
```

**é—®é¢˜**:
- vite.config.ts ä¸­é…ç½®çš„æ˜¯ 3100 ç«¯å£
- ä½†è„šæœ¬ç¡¬ç¼–ç æ˜¾ç¤º 3004ï¼Œå¯¼è‡´ç”¨æˆ·è®¿é—®é”™è¯¯çš„åœ°å€

## ğŸš€ éªŒè¯ä¿®å¤

### 1. å‰ç«¯å¯åŠ¨éªŒè¯

```bash
$ cd /home/ubuntu/jaaz
$ bash restart_frontend.sh

âœ… å‰ç«¯å¯åŠ¨æˆåŠŸï¼
   è¿›ç¨‹ID: 521657
   ç«¯å£: 3100
   æ—¥å¿—: tail -f /tmp/jaaz_frontend.log

è®¿é—®: http://localhost:3100/canvas/default
```

### 2. æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# å‰ç«¯
$ netstat -tlnp | grep 3100
LISTEN  127.0.0.1:3100  users:(("node",pid=521657))

# åç«¯
$ netstat -tlnp | grep 58000
LISTEN  127.0.0.1:58000  users:(("python",pid=516893))
```

### 3. è®¿é—®æµ‹è¯•

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
http://localhost:3100/canvas/default
```

åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ï¼š
- âœ… ç”»å¸ƒç•Œé¢æ­£å¸¸åŠ è½½
- âœ… ä¸å†æ˜¾ç¤ºè½¬åœˆåŠ¨ç”»
- âœ… æ²¡æœ‰ 404 é”™è¯¯
- âœ… æ§åˆ¶å°æ˜¾ç¤º "Development mode: skipping token refresh"

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `react/src/api/auth.ts` | ğŸ”§ ä¿®å¤ | å¼€å‘æ¨¡å¼ä¸‹è·³è¿‡ cloud API è°ƒç”¨ |
| `react/src/contexts/configs.tsx` | âš¡ ä¼˜åŒ– | æ·»åŠ  retry é™åˆ¶ï¼Œä¼˜åŒ– staleTime |
| `restart_frontend.sh` | ğŸ“ ä¿®æ­£ | ä¿®æ­£ç«¯å£æ˜¾ç¤ºä» 3004 æ”¹ä¸º 3100 |

## ğŸ¯ å…³é”®è¦ç‚¹

1. **ç¯å¢ƒåŒºåˆ†å¾ˆé‡è¦**
   - å¼€å‘æ¨¡å¼ï¼ˆ`BASE_API_URL === ''`ï¼‰ä¸åº”è°ƒç”¨ cloud API
   - ç”Ÿäº§æ¨¡å¼ï¼ˆ`BASE_API_URL === 'https://jaaz.app'`ï¼‰æ‰è°ƒç”¨ cloud API

2. **é¿å…é˜»å¡åˆå§‹åŒ–**
   - Provider çš„åˆå§‹åŒ–é€»è¾‘ä¸åº”è¯¥é˜»å¡åº”ç”¨å¯åŠ¨
   - API è°ƒç”¨åº”è¯¥æœ‰è¶…æ—¶å’Œé‡è¯•é™åˆ¶
   - ä½¿ç”¨ `try-catch` ä¼˜é›…å¤„ç†å¤±è´¥

3. **åç«¯ API è·¯ç”±**
   - æœ¬åœ°åç«¯åªæœ‰åŸºç¡€åŠŸèƒ½è·¯ç”±
   - Cloud APIï¼ˆdevice auth, billingç­‰ï¼‰åªåœ¨ jaaz.app å­˜åœ¨
   - å‰ç«¯éœ€è¦æ ¹æ®ç¯å¢ƒåˆ¤æ–­è°ƒç”¨å“ªäº› API

## ğŸ” è°ƒè¯•å·¥å…·

å¦‚æœä»¥åå†é‡åˆ°ç±»ä¼¼é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

### 1. è¯Šæ–­é¡µé¢
```
http://localhost:3100/diagnose_frontend.html
```

### 2. æµè§ˆå™¨æ§åˆ¶å°
```javascript
// æ£€æŸ¥ç¯å¢ƒå˜é‡
console.log('BASE_API_URL:', import.meta.env.VITE_JAAZ_BASE_API_URL)
console.log('DEV mode:', import.meta.env.DEV)

// æ£€æŸ¥ localStorage
console.log('Token:', localStorage.getItem('jaaz_access_token'))
console.log('User:', localStorage.getItem('jaaz_user_info'))

// æµ‹è¯• API
fetch('/api/config').then(r => r.json()).then(console.log)
```

### 3. æŸ¥çœ‹æ—¥å¿—
```bash
# å‰ç«¯æ—¥å¿—
tail -f /tmp/jaaz_frontend.log

# åç«¯æ—¥å¿—
tail -f /home/ubuntu/jaaz/server/backend.log
```

## âœ… é—®é¢˜å·²è§£å†³

ç°åœ¨å¯ä»¥æ­£å¸¸è®¿é—®ï¼š
```
http://localhost:3100/canvas/default
```

é¡µé¢åº”è¯¥æ­£å¸¸åŠ è½½ï¼Œä¸å†å‡ºç°æ— é™è½¬åœˆçš„é—®é¢˜ï¼ğŸ‰





