# Gemini API 配额问题解决指南

## 🚫 问题现象

当您看到以下错误时，表示 Gemini API 配额已用尽：

```
429 RESOURCE_EXHAUSTED
You exceeded your current quota, please check your plan and billing details.
```

## 📊 配额限制说明

### 免费版配额
- **每分钟请求数（RPM）**：15 次
- **每天请求数（RPD）**：1,500 次
- **每分钟 Token 数（TPM）**：1,000,000 tokens

### 付费版配额（需升级）
- **每分钟请求数（RPM）**：1,000 次
- **每天请求数（RPD）**：无限制
- **每分钟 Token 数（TPM）**：4,000,000 tokens

## ✅ 解决方案

### 方案1：等待配额恢复（推荐用于免费用户）

**如果超过每分钟限制（RPM）**：
- ⏰ 等待 1-2 分钟后重试
- 系统会自动重试（已添加重试机制）

**如果超过每天限制（RPD）**：
- ⏰ 等到第二天（UTC 时区凌晨 0 点）
- 或者升级到付费计划

### 方案2：查看配额使用情况

访问配额管理页面查看当前使用情况：

🔗 **配额监控页面**：https://ai.dev/usage?tab=rate-limit

在此页面可以看到：
- ✅ 当前已使用的配额
- ✅ 配额重置时间
- ✅ 每日/每分钟使用趋势

### 方案3：升级到付费计划

如果您需要处理大量 PSD 文件或频繁使用智能缩放功能，建议升级到付费计划。

#### 升级步骤：

1. **访问 Google AI Studio**
   - 🔗 https://aistudio.google.com/

2. **进入计费设置**
   - 点击右上角的账户设置
   - 选择 "Billing"（计费）

3. **选择付费计划**
   - 选择适合您的计划
   - 绑定支付方式

4. **更新 API Key**（如果需要）
   - 某些情况下可能需要重新生成 API Key
   - 在项目根目录运行：`python setup_gemini_key.py`

### 方案4：优化使用频率

**减少 API 调用次数**：
- ✅ 避免短时间内多次调整同一个 PSD 文件
- ✅ 先使用预览功能确认效果
- ✅ 批量处理多个文件时，添加间隔时间

**使用更高效的设置**：
- ✅ 减少图层数量（合并不必要的图层）
- ✅ 使用合理的目标尺寸（不要过大）
- ✅ 优先处理重要文件

## 🔧 系统改进（已自动实施）

我们已经为您的系统添加了以下改进：

### 1. **自动重试机制**（后端）
```python
# 系统会在遇到配额错误时自动重试
# 重试间隔：5秒 → 10秒 → 20秒（指数退避）
# 最大重试次数：3次
```

### 2. **友好的错误提示**（前端）
```
现在配额错误会显示清晰的错误消息，包括：
✅ 配额限制说明
✅ 解决方案步骤
✅ 配额管理链接
```

### 3. **智能错误识别**
```
系统会自动识别以下配额相关错误：
- 429 错误码
- RESOURCE_EXHAUSTED 状态
- quota 关键词
- rate limit 关键词
```

## 📱 常见问题

### Q1: 我刚才还能用，为什么现在不能用了？
**A**: 可能是短时间内使用次数过多，触发了每分钟 15 次的限制。等待 1-2 分钟后重试。

### Q2: 我今天第一次使用就提示配额用尽？
**A**: 可能是昨天的使用量已达到每天 1,500 次限制。等到今天（UTC 时区）凌晨 0 点后重试。

### Q3: 重试功能是自动的吗？
**A**: 是的！系统会自动重试 3 次，每次间隔递增（5秒、10秒、20秒）。您无需手动操作。

### Q4: 如何知道我用了多少配额？
**A**: 访问 https://ai.dev/usage?tab=rate-limit 查看详细的使用统计。

### Q5: 付费计划多少钱？
**A**: Gemini API 的定价根据使用量计费。具体价格请访问 https://ai.google.dev/pricing 查看。

### Q6: 可以使用多个 API Key 轮换吗？
**A**: 技术上可行，但不推荐。建议直接升级到付费计划以获得更高配额。

## 🎯 最佳实践

### 对于个人用户（免费版）
1. ✅ 合理安排使用时间，避免集中处理
2. ✅ 使用预览功能确认效果后再正式处理
3. ✅ 优化 PSD 文件（减少图层数量）
4. ✅ 定期查看配额使用情况

### 对于商业用户（推荐付费版）
1. ✅ 升级到付费计划获得更高配额
2. ✅ 设置使用监控和预算提醒
3. ✅ 实施批处理流程
4. ✅ 考虑使用 Gemini API 的缓存功能

## 📞 获取帮助

如果您在解决配额问题时遇到困难，可以：

1. **查看 Google AI 文档**
   - 🔗 https://ai.google.dev/gemini-api/docs/rate-limits

2. **联系 Google AI 支持**
   - 🔗 https://ai.google.dev/support

3. **查看项目故障排查文档**
   - 📄 `GEMINI_API_TROUBLESHOOTING.md`

---

## 🔄 更新日志

- **2025-10-28**: 添加自动重试机制和友好错误提示
- **2025-10-28**: 创建配额问题解决指南

---

💡 **提示**：大多数配额问题只需等待几分钟即可自动恢复。如果您需要频繁使用智能缩放功能，强烈建议升级到付费计划。

