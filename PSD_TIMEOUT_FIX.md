# PSD智能缩放和画布保存超时问题修复

## 问题描述

1. **画布保存错误**: `POST http://localhost:3100/api/canvas/default/save net::ERR_INVALID_HTTP_RESPONSE`
2. **智能缩放超时**: 点击智能缩放时出现"处理超时（超过5分钟）"错误

## 修复内容

### 1. 前端优化 (`react/src/components/canvas/menu/CanvasToolMenu.tsx`)

- ✅ **增加超时时间**: 从5分钟（300秒）增加到10分钟（600秒）
- ✅ **改进错误提示**: 提供更详细的错误信息和解决建议
  - 说明可能的原因：Gemini API配额限制、图层过多、网络问题等
  - 提供具体建议：等待重试、简化图层、检查配额状态

### 2. 后端优化 (`server/services/gemini_psd_resize_service.py`)

- ✅ **添加API超时控制**: Gemini API调用设置8分钟超时（480秒）
- ✅ **使用asyncio.wait_for**: 包装API调用，防止无限等待
- ✅ **改进日志**: 记录超时时间，便于调试

### 3. 画布保存优化 (`react/src/api/canvas.ts`)

- ✅ **添加保存超时**: 设置60秒超时，避免大文件导致挂起
- ✅ **使用AbortController**: 优雅处理超时情况
- ✅ **改进错误处理**: 超时时仅记录警告，不影响用户使用（数据保存在本地）

### 4. 服务器配置优化 (`server/main.py`)

- ✅ **增加并发请求限制**: 从默认值提升到10000
- ✅ **延长连接保持时间**: 设置为120秒（2分钟）
- ✅ **添加配置注释**: 说明各参数用途

## 技术细节

### 超时时间层级设计

```
前端智能缩放超时: 600秒 (10分钟)
    └─> 后端Gemini API超时: 480秒 (8分钟)
        └─> 网络请求重试机制: 3次（指数退避）

前端画布保存超时: 60秒
    └─> 后端处理: 无硬性超时（依赖数据库性能）
```

### 错误处理策略

1. **智能缩放**: 超时时向用户显示详细错误信息和建议
2. **画布保存**: 超时时仅记录警告，不中断用户操作
3. **Gemini API**: 配额错误自动重试（5秒、10秒、20秒间隔）

## 使用说明

### 1. 重启后端服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
cd /home/ubuntu/jaaz
bash start.sh
```

### 2. 刷新前端页面

在浏览器中刷新页面以加载新的前端代码。

### 3. 验证修复

1. **测试智能缩放**:
   - 上传一个PSD文件
   - 点击智能缩放
   - 应该有更长的处理时间（最多10分钟）
   - 超时时会显示改进的错误提示

2. **测试画布保存**:
   - 在画布上添加多个元素
   - 自动保存应该正常工作
   - 即使超时，画布数据仍保存在本地

## 最佳实践建议

### 对于智能缩放功能

1. **优化PSD文件**:
   - 建议图层数量 < 20层
   - 合并不必要的图层
   - 删除隐藏或空白图层

2. **合理设置目标尺寸**:
   - 避免过大的缩放比例
   - 建议目标尺寸不超过4000x4000像素

3. **检查Gemini API配额**:
   - 访问: https://ai.dev/usage?tab=rate-limit
   - 免费配额: 每分钟15次，每天1500次
   - 超过配额时等待几分钟后重试

### 对于画布保存功能

1. **定期清理画布**:
   - 删除不需要的元素
   - 避免过多高分辨率图像

2. **监控网络状况**:
   - 确保网络连接稳定
   - 大文件保存时避免网络中断

## 故障排查

### 如果仍然超时

1. **检查后端日志**:
   ```bash
   # 查看服务器日志
   tail -f /home/ubuntu/jaaz/server/logs/app.log
   ```

2. **检查Gemini API状态**:
   - 确认API密钥有效
   - 检查配额使用情况
   - 验证网络连接

3. **减少PSD复杂度**:
   - 简化图层结构
   - 降低图像分辨率
   - 分批处理大型项目

### 如果画布保存失败

1. **检查浏览器控制台**:
   - 查看是否有网络错误
   - 检查请求payload大小

2. **检查后端服务**:
   ```bash
   # 确认服务正在运行
   ps aux | grep python | grep main.py
   ```

3. **清理浏览器缓存**:
   - 清除浏览器缓存
   - 重新加载页面

## 相关文件

- `react/src/components/canvas/menu/CanvasToolMenu.tsx` - 智能缩放UI和逻辑
- `react/src/api/canvas.ts` - 画布保存API
- `server/services/gemini_psd_resize_service.py` - Gemini API集成
- `server/main.py` - 服务器配置
- `server/routers/psd_resize_router.py` - PSD缩放路由

## 更新日期

2025-10-29

## 作者

AI Assistant (Claude Sonnet 4.5)

