# ÂâçÁ´ØÊ°ÜÈÄâPSDÂõæÂ±ÇÊï∞ÊçÆËé∑ÂèñÊåáÂçó

## üìã ÁõÆÂΩï

- [Ê¶ÇËø∞](#Ê¶ÇËø∞)
- [Ê†∏ÂøÉAPI](#Ê†∏ÂøÉapi)
- [Ëé∑ÂèñÈÄâ‰∏≠PSDÂõæÂ±ÇÁöÑÂÆåÊï¥ÊñπÊ≥ï](#Ëé∑ÂèñÈÄâ‰∏≠psdÂõæÂ±ÇÁöÑÂÆåÊï¥ÊñπÊ≥ï)
- [ÂÆûÈôÖÂ∫îÁî®Ê°à‰æã](#ÂÆûÈôÖÂ∫îÁî®Ê°à‰æã)
- [‰ª£Á†ÅÂÆûÁé∞‰ΩçÁΩÆ](#‰ª£Á†ÅÂÆûÁé∞‰ΩçÁΩÆ)
- [ÂÆåÊï¥Â∑•ÂÖ∑ÂáΩÊï∞Â∫ì](#ÂÆåÊï¥Â∑•ÂÖ∑ÂáΩÊï∞Â∫ì)

---

## Ê¶ÇËø∞

ÂΩìÁî®Êà∑Âú®ÁîªÂ∏É‰∏äÊ°ÜÈÄâÔºàÊàñÁÇπÂáªÈÄâ‰∏≠ÔºâPSDÂõæÂ±ÇÂêéÔºåÂâçÁ´ØÂèØ‰ª•ÈÄöËøáExcalidraw APIËé∑ÂèñËøô‰∫õÈÄâ‰∏≠ÂõæÂ±ÇÁöÑÂÆåÊï¥Êï∞ÊçÆ„ÄÇ

### Ê†∏ÂøÉÊï∞ÊçÆÂåÖÊã¨

- ‚úÖ **ÈÄâ‰∏≠Áä∂ÊÄÅ** - Âì™‰∫õÂÖÉÁ¥†Ë¢´ÈÄâ‰∏≠
- ‚úÖ **ÂõæÂ±Ç‰ø°ÊÅØ** - PSDÂõæÂ±ÇÁöÑcustomData
- ‚úÖ **‰ΩçÁΩÆÂ∞∫ÂØ∏** - ÁîªÂ∏É‰∏äÁöÑÂùêÊ†áÂíåÂ§ßÂ∞è
- ‚úÖ **ÂõæÁâáÊï∞ÊçÆ** - Base64ÂõæÁâáÂÜÖÂÆπ
- ‚úÖ **ËßÜËßâÂ±ûÊÄß** - ÈÄèÊòéÂ∫¶„ÄÅÊ∑∑ÂêàÊ®°ÂºèÁ≠â

---

## Ê†∏ÂøÉAPI

### 1. Ëé∑ÂèñÂ∫îÁî®Áä∂ÊÄÅÂíåÈÄâ‰∏≠ID

```typescript
const appState = excalidrawAPI.getAppState()
const selectedIds = appState.selectedElementIds

// selectedIds ÁªìÊûÑÔºö
// {
//   "element_id_1": true,
//   "element_id_2": true,
// }
```

### 2. Ëé∑ÂèñÊâÄÊúâÁîªÂ∏ÉÂÖÉÁ¥†

```typescript
const elements = excalidrawAPI.getSceneElements()
```

### 3. Ëé∑ÂèñÊñá‰ª∂Êï∞ÊçÆ

```typescript
const files = excalidrawAPI.getFiles()
```

---

## Ëé∑ÂèñÈÄâ‰∏≠PSDÂõæÂ±ÇÁöÑÂÆåÊï¥ÊñπÊ≥ï

### ÊñπÊ≥ï1ÔºöÂü∫Á°ÄËé∑ÂèñÔºàÊé®ËçêÔºâ

```typescript
function getSelectedPSDLayers(excalidrawAPI: any) {
  const appState = excalidrawAPI.getAppState()
  const selectedIds = appState.selectedElementIds
  
  if (Object.keys(selectedIds).length === 0) {
    return []
  }
  
  const elements = excalidrawAPI.getSceneElements()
  
  const selectedPSDLayers = elements.filter(element => 
    selectedIds[element.id] &&
    element.type === 'image' &&
    element.customData?.psdFileId &&
    element.customData?.psdLayerIndex !== undefined
  )
  
  return selectedPSDLayers
}
```

### ÊñπÊ≥ï2ÔºöËé∑ÂèñÂÆåÊï¥‰ø°ÊÅØÔºàÂåÖÂê´ÂõæÁâáÊï∞ÊçÆÔºâ

```typescript
function getSelectedPSDLayersFullInfo(excalidrawAPI: any) {
  const appState = excalidrawAPI.getAppState()
  const selectedIds = appState.selectedElementIds
  const elements = excalidrawAPI.getSceneElements()
  const files = excalidrawAPI.getFiles()
  
  const selectedPSDElements = elements.filter(element =>
    selectedIds[element.id] &&
    element.type === 'image' &&
    element.customData?.psdFileId &&
    element.customData?.psdLayerIndex !== undefined
  )
  
  if (selectedPSDElements.length === 0) {
    return null
  }
  
  const psdFileId = selectedPSDElements[0].customData.psdFileId
  
  return {
    psdFileId: psdFileId,
    count: selectedPSDElements.length,
    selectedLayerIndices: selectedPSDElements.map(
      el => el.customData.psdLayerIndex
    ),
    layers: selectedPSDElements.map(element => {
      const fileData = files[element.fileId]
      
      return {
        elementId: element.id,
        fileId: element.fileId,
        psdFileId: element.customData.psdFileId,
        layerIndex: element.customData.psdLayerIndex,
        layerName: element.customData.layerName,
        position: {
          x: element.x,
          y: element.y,
          width: element.width,
          height: element.height
        },
        opacity: element.opacity,
        originalOpacity: element.customData.originalOpacity,
        blendMode: element.customData.blendMode,
        imageData: fileData ? {
          mimeType: fileData.mimeType,
          dataURL: fileData.dataURL,
          size: fileData.dataURL?.length || 0
        } : null
      }
    })
  }
}
```

---

## ÂÆûÈôÖÂ∫îÁî®Ê°à‰æã

### Ê°à‰æã1Ôºöpop-bar - ÈÄâ‰∏≠ÂõæÂ±ÇÂºπÁ™ó

**‰ΩçÁΩÆ**: `react/src/components/canvas/pop-bar/index.tsx`

```typescript
excalidrawAPI?.onChange((elements, appState, files) => {
  const selectedIds = appState.selectedElementIds
  
  if (Object.keys(selectedIds).length === 0) {
    return
  }
  
  // Á≠õÈÄâÈÄâ‰∏≠ÁöÑÂõæÁâáÂÖÉÁ¥†ÔºàÂåÖÊã¨PSDÂõæÂ±ÇÔºâ
  const selectedImages = elements.filter(
    (element) => element.type === 'image' && selectedIds[element.id]
  )
  
  // Â§ÑÁêÜÂõæÁâáÊï∞ÊçÆ
  selectedImagesRef.current = selectedImages
    .filter((image) => image.fileId)
    .map((image) => {
      const file = files[image.fileId!]
      return {
        fileId: file.id,
        base64: file.dataURL,
        width: image.width,
        height: image.height,
      }
    })
})
```

### Ê°à‰æã2ÔºöPSDResizeDialog - Êô∫ËÉΩÁº©Êîæ

**‰ΩçÁΩÆ**: `react/src/components/canvas/PSDResizeDialog.tsx`

```typescript
export function PSDResizeDialog({ 
  selectedLayerIndices  // ÈÄâ‰∏≠ÁöÑÂõæÂ±ÇÁ¥¢Âºï
}: PSDResizeDialogProps) {
  
  React.useEffect(() => {
    if (selectedLayerIndices && selectedLayerIndices.length > 0) {
      console.log('ÈÄâ‰∏≠ÂõæÂ±Ç:', selectedLayerIndices)
      setResizeMode('selected')
    }
  }, [selectedLayerIndices])
  
  const handleResize = async () => {
    const formData = new FormData()
    formData.append('layer_indices', JSON.stringify(selectedLayerIndices))
    // Ë∞ÉÁî®API...
  }
}
```

### Ê°à‰æã3ÔºöPSDLayerSidebar - ÂõæÂ±Ç‰æßËæπÊ†è

**‰ΩçÁΩÆ**: `react/src/components/canvas/PSDLayerSidebar.tsx`

```typescript
useEffect(() => {
  const updateCanvasElements = () => {
    const elements = excalidrawAPI.getSceneElements()
    const psdElements = elements.filter(
      element => element.customData?.psdFileId
    )
    setCanvasElements(psdElements)
  }
  
  updateCanvasElements()
  const unsubscribe = excalidrawAPI.on?.('change', updateCanvasElements)
  
  return () => unsubscribe?.()
}, [excalidrawAPI])
```

---

## ‰ª£Á†ÅÂÆûÁé∞‰ΩçÁΩÆ

| Êñá‰ª∂ | ÂäüËÉΩ | Ë°åÂè∑ |
|-----|------|------|
| `pop-bar/index.tsx` | ÁõëÂê¨ÈÄâ‰∏≠ÂèòÂåñ | 21-110 |
| `PSDResizeDialog.tsx` | Êô∫ËÉΩÁº©Êîæ | 43-61 |
| `PSDLayerSidebar.tsx` | ÂõæÂ±ÇÁÆ°ÁêÜ | 75-102 |
| `CanvasExport.tsx` | ÂØºÂá∫ÂäüËÉΩ | 40-42 |
| `CanvasMagicGenerator.tsx` | AIÁîüÊàê | 26-31 |

---

## ÂÆåÊï¥Â∑•ÂÖ∑ÂáΩÊï∞Â∫ì

```typescript
// utils/psdLayerSelection.ts

/**
 * Âà§Êñ≠ÂÖÉÁ¥†ÊòØÂê¶‰∏∫PSDÂõæÂ±Ç
 */
export function isPSDLayer(element: any): boolean {
  return !!(
    element.type === 'image' &&
    element.customData?.psdFileId &&
    element.customData?.psdLayerIndex !== undefined
  )
}

/**
 * Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊâÄÊúâPSDÂõæÂ±Ç
 */
export function getSelectedPSDLayers(excalidrawAPI: any) {
  const appState = excalidrawAPI.getAppState()
  const selectedIds = appState.selectedElementIds
  
  if (Object.keys(selectedIds).length === 0) {
    return []
  }
  
  const elements = excalidrawAPI.getSceneElements()
  return elements.filter(element => 
    selectedIds[element.id] && isPSDLayer(element)
  )
}

/**
 * Ëé∑ÂèñÈÄâ‰∏≠PSDÂõæÂ±ÇÁöÑÂÆåÊï¥‰ø°ÊÅØ
 */
export function getSelectedPSDLayersFullInfo(excalidrawAPI: any) {
  const appState = excalidrawAPI.getAppState()
  const selectedIds = appState.selectedElementIds
  const elements = excalidrawAPI.getSceneElements()
  const files = excalidrawAPI.getFiles()
  
  const selectedPSDElements = elements.filter(element =>
    selectedIds[element.id] && isPSDLayer(element)
  )
  
  if (selectedPSDElements.length === 0) {
    return null
  }
  
  const psdFileId = selectedPSDElements[0].customData.psdFileId
  
  return {
    psdFileId,
    count: selectedPSDElements.length,
    selectedLayerIndices: selectedPSDElements.map(
      el => el.customData.psdLayerIndex
    ),
    layers: selectedPSDElements.map(element => {
      const fileData = files[element.fileId]
      return {
        elementId: element.id,
        fileId: element.fileId,
        psdFileId: element.customData.psdFileId,
        layerIndex: element.customData.psdLayerIndex,
        layerName: element.customData.layerName,
        position: {
          x: element.x,
          y: element.y,
          width: element.width,
          height: element.height
        },
        opacity: element.opacity,
        originalOpacity: element.customData.originalOpacity,
        blendMode: element.customData.blendMode,
        imageData: fileData ? {
          dataURL: fileData.dataURL,
          mimeType: fileData.mimeType,
          size: fileData.dataURL?.length || 0
        } : null
      }
    })
  }
}

/**
 * ÊåâPSDÊñá‰ª∂ÂàÜÁªÑÈÄâ‰∏≠ÁöÑÂõæÂ±Ç
 */
export function groupSelectedLayersByPSD(excalidrawAPI: any) {
  const selectedLayers = getSelectedPSDLayers(excalidrawAPI)
  const grouped = new Map<string, any[]>()
  
  selectedLayers.forEach(layer => {
    const psdFileId = layer.customData.psdFileId
    if (!grouped.has(psdFileId)) {
      grouped.set(psdFileId, [])
    }
    grouped.get(psdFileId)!.push(layer)
  })
  
  return grouped
}

/**
 * Ëé∑ÂèñÈÄâ‰∏≠ÂõæÂ±ÇÁöÑËæπÁïåÊ°Ü
 */
export function getSelectedLayersBoundingBox(excalidrawAPI: any) {
  const selectedLayers = getSelectedPSDLayers(excalidrawAPI)
  
  if (selectedLayers.length === 0) return null
  
  let minX = Infinity, minY = Infinity
  let maxX = -Infinity, maxY = -Infinity
  
  selectedLayers.forEach(layer => {
    minX = Math.min(minX, layer.x)
    minY = Math.min(minY, layer.y)
    maxX = Math.max(maxX, layer.x + layer.width)
    maxY = Math.max(maxY, layer.y + layer.height)
  })
  
  return {
    x: minX,
    y: minY,
    width: maxX - minX,
    height: maxY - minY,
    centerX: (minX + maxX) / 2,
    centerY: (minY + maxY) / 2
  }
}

/**
 * ÊåâÂõæÂ±ÇÁ¥¢ÂºïÊéíÂ∫è
 */
export function sortSelectedLayersByIndex(excalidrawAPI: any) {
  const selectedLayers = getSelectedPSDLayers(excalidrawAPI)
  return selectedLayers.sort((a, b) => {
    return (a.customData?.psdLayerIndex ?? 0) - (b.customData?.psdLayerIndex ?? 0)
  })
}
```

### ‰ΩøÁî®Á§∫‰æã

```typescript
import { getSelectedPSDLayersFullInfo } from '@/utils/psdLayerSelection'

const handleButtonClick = () => {
  const fullInfo = getSelectedPSDLayersFullInfo(excalidrawAPI)
  
  if (fullInfo) {
    console.log('PSDÊñá‰ª∂ID:', fullInfo.psdFileId)
    console.log('ÈÄâ‰∏≠ÂõæÂ±ÇÊï∞:', fullInfo.count)
    console.log('ÂõæÂ±ÇÁ¥¢Âºï:', fullInfo.selectedLayerIndices)
    
    fullInfo.layers.forEach(layer => {
      console.log(`ÂõæÂ±Ç "${layer.layerName}":`, {
        Á¥¢Âºï: layer.layerIndex,
        ‰ΩçÁΩÆ: `(${layer.position.x}, ${layer.position.y})`,
        Â∞∫ÂØ∏: `${layer.position.width}x${layer.position.height}`,
        ÈÄèÊòéÂ∫¶: layer.opacity
      })
    })
  }
}
```

---

## ÂÖ≥ÈîÆË¶ÅÁÇπÊÄªÁªì

### Êï∞ÊçÆÊµÅËΩ¨

```
Áî®Êà∑Ê°ÜÈÄâÂõæÂ±Ç 
  ‚Üì
appState.selectedElementIds Êõ¥Êñ∞
  ‚Üì
onChange ‰∫ã‰ª∂Ëß¶Âèë
  ‚Üì
Á≠õÈÄâÈÄâ‰∏≠ÁöÑPSDÂõæÂ±Ç
  ‚Üì
ÊèêÂèñÂÆåÊï¥Êï∞ÊçÆ
  ‚Üì
ÊâßË°åÂêéÁª≠Êìç‰Ωú
```

### Ê†∏ÂøÉÂà§Êñ≠Êù°‰ª∂

```typescript
// Âà§Êñ≠ÊòØÂê¶‰∏∫ÈÄâ‰∏≠ÁöÑPSDÂõæÂ±Ç
selectedIds[element.id] &&           // 1. Ë¢´ÈÄâ‰∏≠
element.type === 'image' &&          // 2. ÊòØÂõæÁâáÁ±ªÂûã
element.customData?.psdFileId &&     // 3. ÊúâPSDÊñá‰ª∂ID
element.customData?.psdLayerIndex !== undefined  // 4. ÊúâÂõæÂ±ÇÁ¥¢Âºï
```

---


